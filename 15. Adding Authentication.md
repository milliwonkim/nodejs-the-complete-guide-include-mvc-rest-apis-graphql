\* Chapter 246: Module Introduction
===================================

![](images/246-module-introduction-1.png)![246-module-introduction-1.png](resources/18103F4F8CBD001801ECD582B397E30C.png)

\* Chapter 247: What Is Authentication?
=======================================

![](images/247-what-is-authentication-1.png)![247-what-is-authentication-1.png](resources/3B7D1C7BD7E7EDCCE8FC28CAD6843347.png)

- The idea behind authentication is that all these actions are available to every user of our application. i don’t mean logged-in user, i mean a person visiting our page, visiting localhost:3000

\* Chapter 248: How Is Authentication Implemented
=================================================

![](images/248-how-is-authentication-implemented-1.png)![248-how-is-authentication-implemented-1.png](resources/29B904B4F62CA09711991A34CF789CDE.png)

- we check whether that email and password combination is valid, whether we have a user with that email and that password in our database. 

- if that is the case, we create a session for this user and this session then identifies this user. this is required because otherwise without a session, even if we find out that the credentials are valid, for the next request the user would be logged out again because requests interact separated from each other, they don’t know anything about each other. we need a session to connect them. 

- then server send 200 response which means a success response and then we store the cookie belonging to that session on the client. so that we established a session

- thereafter, the user is able to visit our restricted routes because this cookie sent with every request, on the server we can connect this cookie to a session and in the session we have the information whether that user is signed in or not. 

\* Chapter 249: Our Updated Project Status
==========================================

1\. update

- changed views folder with new thing

- ./routes/auth.js

- ./controllers/auth.js

![](images/249-our-updated-project-status-1.png)![249-our-updated-project-status-1.png](resources/A24CE9879C4655F12B272845A915F87E.png)

```js
// ./routes/auth.js

const express = require('express')

const authController = require('../controllers/auth')

const router = express.Router()

router.get('/login', authController.getLogin)

router.get('/signup', authController.getSignup)

router.post('/login', authController.postLogin)

router.post('/signup', authController.postSignup)

router.post('/logout', authController.postLogout)

module.exports = router
```

```js
//./controllers/auth.js

const User = require('../models/user');

exports.getLogin = (req, res, next) => {
  res.render('auth/login', {
    path: '/login',
    pageTitle: 'Login',
    isAuthenticated: false
  });
};

exports.getSignup = (req, res, next) => {
  res.render('auth/signup', {
    path: '/signup',
    pageTitle: 'Signup',
    isAuthenticated: false
  });
};

exports.postLogin = (req, res, next) => {
  User.findById('5cbb2b2c80bd7193adb9eeeb')
    .then(user => {
      req.session.isLoggedIn = true;
      req.session.user = user;
      req.session.save(err => {
        console.log(err);
        res.redirect('/');
      });
    })
    .catch(err => console.log(err));
};

exports.postSignup = (req, res, next) => {};

exports.postLogout = (req, res, next) => {
  req.session.destroy(err => {
    console.log(err);
    res.redirect('/');
  });
};

```

\* Chapter 250: Implementing An Authentication Flow
===================================================

1\. update

- ./views/auth/signup.ejs

- ./controllers/auth.js

- ./models/user.js

- app.js

![](images/250-implementing-an-authentication-flow-1.png)

![](images/250-implementing-an-authentication-flow-2.png)

![](images/250-implementing-an-authentication-flow-3.png)

![](images/250-implementing-an-authentication-flow-4.png)

![](images/250-implementing-an-authentication-flow-5.png)![250-implementing-an-authentication-flow-1.png](resources/DC7BF77690899645ADA8124269599637.png)![250-implementing-an-authentication-flow-2.png](resources/252EDC5C48C2E84F1B7A2087DD88840C.png)![250-implementing-an-authentication-flow-3.png](resources/48CEF6FA6587EB602BE60F4446F323F4.png)![250-implementing-an-authentication-flow-4.png](resources/C61E81BDEF4310A8D356C2627E3F8355.png)![250-implementing-an-authentication-flow-5.png](resources/50131F1CD24B9633F745CAB25248164E.png)

```js
<!--./views/auth/signup.ejs-->

<%- include('../includes/head.ejs') %>
    <link rel="stylesheet" href="/css/forms.css">
    <link rel="stylesheet" href="/css/auth.css">
</head>

<body>
   <%- include('../includes/navigation.ejs') %>

    <main>
        <!--in the action now '/signup' send a POST request to reach that sign up the POST signup route
        which triggers the POST sign up action-->
        <form class="login-form" action="/signup" method="POST">
            <div class="form-control">
                <label for="email">E-Mail</label>
                <input type="email" name="email" id="email">
            </div>
            <div class="form-control">
                <label for="password">Password</label>
                <input type="password" name="password" id="password">
            </div>
            <div class="form-control">
                <label for="confirmPassword">Confirm Password</label>
                <input type="password" name="confirmPassword" id="confirmPassword">
            </div>
            <button class="btn" type="submit">Signup</button>
        </form>
    </main>
<%- include('../includes/end.ejs') %>
```

```js
//./controllers/auth.js

const User = require('../models/user');

exports.getLogin = (req, res, next) => {
  res.render('auth/login', {
    path: '/login',
    pageTitle: 'Login',
    isAuthenticated: false
  });
};

exports.getSignup = (req, res, next) => {
  res.render('auth/signup', {
    path: '/signup',
    pageTitle: 'Signup',
    isAuthenticated: false
  });
};

exports.postLogin = (req, res, next) => {
  User.findById('5cbb2b2c80bd7193adb9eeeb')
    .then(user => {
      req.session.isLoggedIn = true;
      req.session.user = user;
      req.session.save(err => {
        console.log(err);
        res.redirect('/');
      });
    })
    .catch(err => console.log(err));
};

exports.postSignup = (req, res, next) => {
  /**we have to make sure how these inputs are named in the ./views/auth/signup.ejs 
   * because you retrieve the values on req.body by these name. 
   * 
  */
  const email = req.body.email
  const password = req.body.password
  const confirmPassword = req.body.confirmPassword
  /**you could create an index in the MongoDB database on your email field
   * and give that index the unique property.
   * 
   * the alternative is that you try to find a user with that e-mail.
   * for that we will use our user model, a mongoose user model
   * we will use 'findOne()' because we already know we don't wanna create a user with that user
   * 
   * 'email' on the right side is the email we are extracting
   * 'email' on the left side is the email we are looking for in the database.
   * 
   */
  User.findOne({email: email})
      .then(userDoc => {
        if(userDoc){
          return res.redirect('/signup')
        }
        const user = new User({
          email: email,
          password: password,
          cart: { items: [] }
        })
        /**we use 'return' so that we can chain another 'then()' block
         * which will be called once this 'save()' action completed.
         */
        return user.save()
      })
      .then(result => {
        res.redirect('/login')
      })
      .catch(err => {
        console.log(err)
      })
};

exports.postLogout = (req, res, next) => {
  req.session.destroy(err => {
    console.log(err);
    res.redirect('/');
  });
};

```

```js
//./models/user.js

const mongoose = require('mongoose')

const Schema = mongoose.Schema

const userSchema = new Schema({
  email: {
    type: String,
    required: true
  },
  password: {
    type: String,
    required: true
  },
  cart: {
    items: [{
      productId: {
        type: Schema.Types.ObjectId,
        ref: 'Product',
        required: true
      },
      quantity: {
        type: Number,
        required: true
      }
      }]
  }
})

userSchema.methods.addToCart = function(product){
  const cartProductIndex = this.cart.items.findIndex(cp => {
    return cp.productId.toString() === product._id.toString();
  });
  let newQuantity = 1;
  const updatedCartItems = [...this.cart.items];
  if (cartProductIndex >= 0) {
    newQuantity = this.cart.items[cartProductIndex].quantity + 1;
    updatedCartItems[cartProductIndex].quantity = newQuantity;
  } else {
    updatedCartItems.push({
      productId: product._id,
      quantity: newQuantity
    });
  }
  const updatedCart = {
    items: updatedCartItems
  }
  this.cart = updatedCart
  return this.save()
}

userSchema.methods.removeFromCart = function(productId){
  const updatedCartItems = this.cart.items.filter(item => {
    return item.productId.toString() !== productId.toString()
  })
  this.cart.items = updatedCartItems
  return this.save()
}

userSchema.methods.clearCart = function(){
  this.cart = { items: [] }
  return this.save()
}

module.exports = mongoose.model('User', userSchema)

```

```js
//app.js

const path = require('path');

const express = require('express');
const bodyParser = require('body-parser');
const mongoose = require('mongoose')
const session = require('express-session')
const MongoDBStore = require('connect-mongodb-session')(session)

const errorController = require('./controllers/error');
const User = require('./models/user')

const MONGODB_URI = 'mongodb+srv://maximilian:DD5EbADjazBuTqk@cluster0-z3vlk.mongodb.net/shop'

const app = express();
const store = new MongoDBStore({
  uri: MONGODB_URI,
  collection: 'sessions'
})

app.set('view engine', 'ejs');
app.set('views', 'views');

const adminRoutes = require('./routes/admin');
const shopRoutes = require('./routes/shop');
const authRoutes = require('./routes/auth');

/**your session data will be stored in there */
app.use(bodyParser.urlencoded({ extended: false }));
app.use(express.static(path.join(__dirname, 'public')));
app.use(
  session({
    secret: 'my secret',
    resave: false,
    saveUninitialized: false,
    store: store
  })
)

app.use((req, res, next) => {
  if(!req.session.user){
    return next()
  }
  User.findById(req.session.user._id)
  .then(user => {
    req.user = user
    next()
  })
  .catch(err => console.log(err));
})

app.use((req, res, next) => {
  User.findById('5cbb2b2c80bd7193adb9eeeb')
    .then(user => {
      req.user = user
      next();
    })
    .catch(err => console.log(err));
});

app.use('/admin', adminRoutes);
app.use(shopRoutes);
app.use(authRoutes)

app.use(errorController.get404);

mongoose
  .connect(
    MONGODB_URI
  )
  .then(result => {
    /**i will get rid of these code
     * because we have a real user creation flow 
     * so we don't need that dummy user.
     */
    /*
    User.findOne()
      .then(user => {
        if(!user){
          const user = new User({
            name: 'Max', email: 'max@test.com', cart: { items: [] }
          })
          user.save()
        }
      })
    */
    app.listen(3000)
  })
  .catch(err => {
    console.log(err)
  })
```

\* Chapter 251: Encrypting Passwords
====================================

1\. update

- ./controllers/auth.js

![](images/251-encrypting-passwords-1.png)![251-encrypting-passwords-1.png](resources/AE9FB0301E693850C37941EA81B33C4B.png)

- the problem is that we store the password in plain text. so what we should do is we should encrypt that password. we should hash it in a way that is not reversible, where people can’t construct the password from. so that even if you get access to the database, you might be able to see the e-mail but you are not able to see the password, the real password that belongs to the email. 

![](images/251-encrypting-passwords-2.png)![251-encrypting-passwords-2.png](resources/68FBEF3E30E7ADFAD5B285D3D51F80DC.png)

- the package ‘bcryptjs’ help us with encryption and that will help us with encrypting the password.

![](images/251-encrypting-passwords-3.png)

![](images/251-encrypting-passwords-4.png)

![](images/251-encrypting-passwords-5.png)![251-encrypting-passwords-3.png](resources/69C55EDF0E054BC6834EC86AADC6F4F2.png)![251-encrypting-passwords-4.png](resources/4347FBEB9BE5A7A3765D273EE278248F.png)![251-encrypting-passwords-5.png](resources/2C2ABE580CEBDEA1376BAA5DE603E704.png)

- this is the hashed value and the important thing is you can’t reconstruct the password i use. you can’t decrypt this. this is why we don’t encrypt the e-mail because we won’t be able to decrypt this. so if we need to send messages to that e-mail, that would not work if we encrypt the e-mail as well because we could not revert that. so we need to store the e-mail like this but the password is secured. it’s not readable. 

![](images/251-encrypting-passwords-6.png)

![](images/251-encrypting-passwords-7.png)![251-encrypting-passwords-6.png](resources/79BCC2AD813338589A35FAB3CD21C6F3.png)![251-encrypting-passwords-7.png](resources/23E06971982D8CDD8CEFE704AA09349E.png)

```js
//./controllers/auth.js

const bcrypt = require('bcryptjs')

const User = require('../models/user');

exports.getLogin = (req, res, next) => {
  res.render('auth/login', {
    path: '/login',
    pageTitle: 'Login',
    isAuthenticated: false
  });
};

exports.getSignup = (req, res, next) => {
  res.render('auth/signup', {
    path: '/signup',
    pageTitle: 'Signup',
    isAuthenticated: false
  });
};

exports.postLogin = (req, res, next) => {
  User.findById('5cbb2b2c80bd7193adb9eeeb')
    .then(user => {
      req.session.isLoggedIn = true;
      req.session.user = user;
      req.session.save(err => {
        console.log(err);
        res.redirect('/');
      });
    })
    .catch(err => console.log(err));
};

exports.postSignup = (req, res, next) => {
  const email = req.body.email
  const password = req.body.password
  const confirmPassword = req.body.confirmPassword
  User.findOne({email: email})
      .then(userDoc => {
        if(userDoc){
          return res.redirect('/signup')
        }
        /**'hash()' method as a first value takes the string which you wanna hash
         * so in our case 'password'. so we will pass the password here.
         * 
         * the 2nd argument then is the salt value.
         * this is specifying how many rounds of hashing will be applied.
         * the higher the value, the longer it will take but the more secure that will be
         * currently a value of 12 is accepted as highly secure
         * 
         * this will generate hash password.
         * this is asynchronous task and therefore gives us back a promise
         * so i will return this so that i can chain another 'then()' block
         */
        return bcrypt.hash(password, 12)
      })
      .then(hashedPassword => {
        const user = new User({
          email: email,
          password: hashedPassword,
          cart: { items: [] }
        })
        return user.save()
      })
      .then(result => {
        res.redirect('/login')
      })
      .catch(err => {
        console.log(err)
      })
};

exports.postLogout = (req, res, next) => {
  req.session.destroy(err => {
    console.log(err);
    res.redirect('/');
  });
};

```

\* Chapter 252: Adding A Tiny Code Improvement
==============================================

1\. update

- /controllers/auth.js

![](images/252-adding-a-tiny-code-improvement-1.png)

![](images/252-adding-a-tiny-code-improvement-2.png)![252-adding-a-tiny-code-improvement-1.png](resources/9D43A73D7B04AA0E0F148198F46844EE.png)![252-adding-a-tiny-code-improvement-2.png](resources/FF9B99E47BE2E992F00EA13D44CCC947.png)

- since i return my redirect to ‘/singup’ here and we do this in ’then()’ block, this will redirect, this is correct

![](images/252-adding-a-tiny-code-improvement-3.png)![252-adding-a-tiny-code-improvement-3.png](resources/F780315CFCEDA92024BBA339488BC1E3.png)

- but it will still execute the next ’then()’ block. this is how promises work. 

![](images/252-adding-a-tiny-code-improvement-4.png)![252-adding-a-tiny-code-improvement-4.png](resources/102F19D55049CE46DF336C8987430967.png)

- so this code execution in this function does finish because i return ‘return res.redirect(‘/signup’)’

![](images/252-adding-a-tiny-code-improvement-5.png)![252-adding-a-tiny-code-improvement-5.png](resources/A98324B404EF4F8F39D1C8950A121B4B.png)

- but the overall code execution does not. 

![](images/252-adding-a-tiny-code-improvement-6.png)![252-adding-a-tiny-code-improvement-6.png](resources/5B157361C3DAD9DFAE3DAFEEB79DB103.png)

- therefore we reached the next ’then()’ block even if we redirect. 

![](images/252-adding-a-tiny-code-improvement-7.png)![252-adding-a-tiny-code-improvement-7.png](resources/00051CBD88AF4B1CF4DBE972C39770E8.png)

- that is why we get this ‘’password’ is required’ error when we use an existing email 

![](images/252-adding-a-tiny-code-improvement-8.png)![252-adding-a-tiny-code-improvement-8.png](resources/5FED832ED40CB659715654242C14CEEE.png)

- because we reached this ’then()’ block and the function in there but hashedPassword will be undefined 

![](images/252-adding-a-tiny-code-improvement-9.png)![252-adding-a-tiny-code-improvement-9.png](resources/0CE3292A0254E4E1694C77393416ECAB.png)

- because since we return after redirecting, we never execute the hash function. ‘bcrypt.hash(password, 12)’

![](images/252-adding-a-tiny-code-improvement-10.png)![252-adding-a-tiny-code-improvement-10.png](resources/1880A3C092556ACB872B63E068A59297.png)

- so we reach this function without the hashedPassword, this is why we get this error. 

![](images/252-adding-a-tiny-code-improvement-11.png)![252-adding-a-tiny-code-improvement-11.png](resources/91410D421DC46B9566D9D2441B072C29.png)

- if you wann avoid this, you can take that code and chain it in here.

- that is a tiny improvement that logically makes more sense here.

```js
//./controllers/auth.js

const bcrypt = require('bcryptjs');

const User = require('../models/user');

exports.getLogin = (req, res, next) => {
  res.render('auth/login', {
    path: '/login',
    pageTitle: 'Login',
    isAuthenticated: false
  });
};

exports.getSignup = (req, res, next) => {
  res.render('auth/signup', {
    path: '/signup',
    pageTitle: 'Signup',
    isAuthenticated: false
  });
};

exports.postLogin = (req, res, next) => {
  User.findById('5cbe722a2de68db0d19186c1')
    .then(user => {
      req.session.isLoggedIn = true;
      req.session.user = user;
      req.session.save(err => {
        console.log(err);
        res.redirect('/');
      });
    })
    .catch(err => console.log(err));
};

exports.postSignup = (req, res, next) => {
  const email = req.body.email;
  const password = req.body.password;
  const confirmPassword = req.body.confirmPassword;
  User.findOne({ email: email })
    .then(userDoc => {
      if (userDoc) {
        return res.redirect('/signup');
      }
      return bcrypt
        .hash(password, 12)
        .then(hashedPassword => {
          const user = new User({
            email: email,
            password: hashedPassword,
            cart: { items: [] }
          });
          return user.save();
        })
        .then(result => {
          res.redirect('/login');
        });
    })
    .catch(err => {
      console.log(err);
    });
};

exports.postLogout = (req, res, next) => {
  req.session.destroy(err => {
    console.log(err);
    res.redirect('/');
  });
};

```

\* Chapter 253: Adding The Signin Functionality
===============================================

1\. update

- ./controllers/auth.js

![](images/253-adding-the-signin-functionality-1.png)

![](images/253-adding-the-signin-functionality-2.png)![253-adding-the-signin-functionality-1.png](resources/EB0979F8D04AA48AEFC0F6FBFBC8887E.png)![253-adding-the-signin-functionality-2.png](resources/A18246B37CEE916AFCACF98F2FD43002.png)

- if i login, i’m redirected back to login, this didn’t seem to succeed. 

![](images/253-adding-the-signin-functionality-3.png)

![](images/253-adding-the-signin-functionality-4.png)

![](images/253-adding-the-signin-functionality-5.png)![253-adding-the-signin-functionality-3.png](resources/5B0E0203F8FF8E2D317CCAE527AD8507.png)![253-adding-the-signin-functionality-4.png](resources/B1F72D409742E243EC853C79539E5EA5.png)![253-adding-the-signin-functionality-5.png](resources/D219570E9D6BB8DBA31171D2A36EC372.png)

- so we can go to the sessions and clear all sessions so that we can really prove that no session was created. 

![](images/253-adding-the-signin-functionality-6.png)

![](images/253-adding-the-signin-functionality-7.png)

![](images/253-adding-the-signin-functionality-8.png)![253-adding-the-signin-functionality-6.png](resources/B9957658790DCD4C6E59FDBE1399F829.png)![253-adding-the-signin-functionality-7.png](resources/0AE850C04737E0D3962CD4E6746E9BC0.png)![253-adding-the-signin-functionality-8.png](resources/36C7EBAE3D7E3FF9D14877EEDADC730C.png)

- let me enter a valid email but an incorrect password and i’m redirected back and no session was created. 

![](images/253-adding-the-signin-functionality-9.png)

![](images/253-adding-the-signin-functionality-10.png)

![](images/253-adding-the-signin-functionality-11.png)![253-adding-the-signin-functionality-9.png](resources/044880E6F2961B06F39909D3073C83C8.png)![253-adding-the-signin-functionality-10.png](resources/36CB5F6037FD57DB88767F9DB6B9DA41.png)![253-adding-the-signin-functionality-11.png](resources/B4BB4649F7086738A47F20A0E3482051.png)

- if we enter the valid email and valid password, now i’m on the starting page, i see all options. and we got no error here. 

![](images/253-adding-the-signin-functionality-12.png)![253-adding-the-signin-functionality-12.png](resources/263C6F6030A4AAADDBC50EE8A9302B21.png)

- and if i have a look at my sessions collection, we have got a session because i’m logged in. and this is the user object with which i’m logged in.

```js
//./controllers/auth.js

const bcrypt = require('bcryptjs');

const User = require('../models/user');

exports.getLogin = (req, res, next) => {
  res.render('auth/login', {
    path: '/login',
    pageTitle: 'Login',
    isAuthenticated: false
  });
};

exports.getSignup = (req, res, next) => {
  res.render('auth/signup', {
    path: '/signup',
    pageTitle: 'Signup',
    isAuthenticated: false
  });
};

exports.postLogin = (req, res, next) => {
  const email = req.body.email
  const password = req.body.password
  User.findOne({ email: email })
    .then(user => {
      if(!user){
        return res.redirect('/login')
      }
      /**we will do this with 'bcrypt'
       * because the password is stored in hashed form
       * and we can't reverse this.
       * so how we can compare the password?
       *
       * 'bcrypt' was responsible for creating the hash
       * bcrypt uses a certain algorithm
       * and we can essentially pass the password the user entered into bcrypt
       * and let bcrypt compare it to the hashed value
       * and bcrypt can then find out if the hashed value does make sense,
       * taking into account the algorithm that is used
       * for creating that for the password you entered as plain text
       * if you would hash it could result in the hash password
       * and if the answer is true, then the user entered a valid password
       *
       * and for this, bcrypt has the 'compare' function
       * and so the password we extract from the incoming request
       * and then the hashed value against we wanna compare it.
       * that is found in our user document which we get from the database
       * and there in the password field.
       */
      bcrypt.compare(password, user.password)
      /**with 'compare', we will only face an error
       * if something goes wrong, not if the password don't match
       * in both a matching and a non-matching case,
       * we make it into 'then' block
       * and result will be a boolean that is true if the passwords are equal
       * and it will be false if they are not equal
       *
       */
            .then(doMatch => {
              if(doMatch){
                req.session.isLoggedIn = true;
                req.session.user = user;
                /**return this
                 * therefore, we should also return this
                 * to avoid code execution of this line "res.redirect('/login')"
                 * because the callback will execute asynchronously,
                 * so this needs to be returned to not execute this line "res.redirect('/login')"
                 */
                return req.session.save(err => {
                  console.log(err);
                  /**we don't need to return 'res.redirect('/')' here
                   * because after this line can't be reached
                   * because this line is in a callback in a different function
                   */
                  res.redirect('/')
                });
              }
              res.redirect('/login')
            })
            .catch(err => {
              console.log(err)
              res.redirect('/login')
            })
    })
    .catch(err => console.log(err));
};

exports.postSignup = (req, res, next) => {
  const email = req.body.email;
  const password = req.body.password;
  const confirmPassword = req.body.confirmPassword;
  User.findOne({ email: email })
    .then(userDoc => {
      if (userDoc) {
        return res.redirect('/signup');
      }
      return bcrypt
        .hash(password, 12)
        .then(hashedPassword => {
          const user = new User({
            email: email,
            password: hashedPassword,
            cart: { items: [] }
          });
          return user.save();
        })
        .then(result => {
          res.redirect('/login');
        });
    })
    .catch(err => {
      console.log(err);
    });
};

exports.postLogout = (req, res, next) => {
  req.session.destroy(err => {
    console.log(err);
    res.redirect('/');
  });
};

```

\* Chapter 254: Working On Route Protection
===========================================

1\. update

- ./controllers/admin.js

![](images/254-working-on-route-protection-1.png)

![](images/254-working-on-route-protection-2.png)![254-working-on-route-protection-1.png](resources/F7550BCA7528B44D4F58291EB7009AF3.png)![254-working-on-route-protection-2.png](resources/FCE716773B70674D46B46C246594188E.png)

- even when i logout and therefore my session is gone, even when i do that, i can still manually enter admin ‘/add-product’ and reach that page and i could even try to creat a product here.

- but i would fail then because there would be no user object on the backend where i tried to get the logged in user. this is not the user experience you wanna offer. 

- so we need to protect our route. 

![](images/254-working-on-route-protection-3.png)

![](images/254-working-on-route-protection-4.png)![254-working-on-route-protection-3.png](resources/0BB6D4BB4D86F8CC4D36C59E13C824CB.png)![254-working-on-route-protection-4.png](resources/CD246E082EA601DD305E6B241586B7FC.png)

- i’m not logged in. and i’m on the login page. so this works, i’m redirected here because session logged in is not set. 

![](images/254-working-on-route-protection-5.png)

![](images/254-working-on-route-protection-6.png)![254-working-on-route-protection-5.png](resources/7750C22E6C692493AAD15E581372A3C8.png)![254-working-on-route-protection-6.png](resources/1047C2C2A3A3AF67A6C62189581C7607.png)

- on the other hand if i login now, this does work because i’m logged in now.

```js
// ./controllers/admin.js

const Product = require('../models/product');

exports.getAddProduct = (req, res, next) => {
  if(!req.session.isLoggedIn){
    return res.redirect('/login')
  }
  res.render('admin/edit-product', {
    pageTitle: 'Add Product',
    path: '/admin/add-product',
    editing: false,
    isAuthenticated: req.isLoggedIn
  });
};

exports.postAddProduct = (req, res, next) => {
  const title = req.body.title;
  const imageUrl = req.body.imageUrl;
  const price = req.body.price;
  const description = req.body.description;
  const product = new Product({
    title: title,
    price: price,
    description: description,
    imageUrl: imageUrl,
    userId: req.user
  })
  product
    .save()
    .then(result => {
      // console.log(result);
      console.log('Created Product');
      res.redirect('/admin/products');
    })
    .catch(err => {
      console.log(err);
    });
};

exports.getEditProduct = (req, res, next) => {
  const editMode = req.query.edit;
  if (!editMode) {
    return res.redirect('/');
  }
  const prodId = req.params.productId;
  Product.findById(prodId)
    .then(product => {
      if (!product) {
        return res.redirect('/');
      }
      res.render('admin/edit-product', {
        pageTitle: 'Edit Product',
        path: '/admin/edit-product',
        editing: editMode,
        product: product,
        isAuthenticated: req.isLoggedIn
      });
    })
    .catch(err => console.log(err));
};

exports.postEditProduct = (req, res, next) => {
  const prodId = req.body.productId;
  const updatedTitle = req.body.title;
  const updatedPrice = req.body.price;
  const updatedImageUrl = req.body.imageUrl;
  const updatedDesc = req.body.description;

  Product
    .findById(prodId)
    .then(product => {
      product.title = updatedTitle
      product.price = updatedPrice
      product.description = updatedDesc
      product.imageUrl = updatedImageUrl
      return product
      .save()
    })
    .then(result => {
      console.log('UPDATED PRODUCT!');
      res.redirect('/admin/products');
    })
    .catch(err => console.log(err));
};

exports.getProducts = (req, res, next) => {
  Product.find()
//   .select('title price -_id')
//   .popultate('userId', 'name')
    .then(products => {
      console.log(products)
      res.render('admin/products', {
        prods: products,
        pageTitle: 'Admin Products',
        path: '/admin/products',
        isAuthenticated: req.isLoggedIn
      });
    })
    .catch(err => console.log(err));
};

exports.postDeleteProduct = (req, res, next) => {
  const prodId = req.body.productId;
  Product.findByIdAndRemove(prodId)
    .then(() => {
      console.log('DESTROYED PRODUCT');
      res.redirect('/admin/products');
    })
    .catch(err => console.log(err));
};
```

\* Chapter 255: Using Middleware To Protect Routes
==================================================

1\. update

- ./middleware/is-auth.js

- ./routes/admin.js

- ./routes/shop.js

![](images/255-using-middleware-to-protect-routes-1.png)![255-using-middleware-to-protect-routes-1.png](resources/EB0FDA4233F202B67D44FB8847AE17B0.png)

- i will try to access admin/add-product in being logged in. and you see i end up on the login page 

- and if i try to access cart, i end up on the login page. 

![](images/255-using-middleware-to-protect-routes-2.png)

![](images/255-using-middleware-to-protect-routes-3.png)

![](images/255-using-middleware-to-protect-routes-4.png)![255-using-middleware-to-protect-routes-2.png](resources/9E7F5FA3F194CC120B02F190E9D72DD5.png)![255-using-middleware-to-protect-routes-3.png](resources/712237085FA05281D296FCD8712B25A1.png)![255-using-middleware-to-protect-routes-4.png](resources/0A80DACFECD29EB0FEB08F106A014AB7.png)

- if i login, i can add a new book with that same image. let’s add this and this works 

![](images/255-using-middleware-to-protect-routes-5.png) 

![](images/255-using-middleware-to-protect-routes-6.png)

![](images/255-using-middleware-to-protect-routes-7.png)

![](images/255-using-middleware-to-protect-routes-8.png)![255-using-middleware-to-protect-routes-5.png](resources/D54FA43A32CD92AA73478442F9C32574.png)![255-using-middleware-to-protect-routes-6.png](resources/FD78D1C38BAC22407598C4D1B950555D.png)![255-using-middleware-to-protect-routes-7.png](resources/8E7FBD4B4E12614449D80C2C9F930C09.png)![255-using-middleware-to-protect-routes-8.png](resources/791CA8FB8DF661660B161425F0D7143C.png)

```js
//./middleware/is-auth.js

module.exports = (req, res, next) => {
    if(!req.session.isLoggedIn){
        return res.redirect('/login')
    }
    /**i will call next
     * because otherwise, i wanna allow the request to continue 
     * to whichever route the request wanted to go to
     */
    next()
}
```

```js
// ./routes/admin.js

const path = require('path');

const express = require('express');

const adminController = require('../controllers/admin');
const isAuth = require('../middleware/is-auth')

const router = express.Router();

// /admin/add-product => GET
/**'isAuth' can now simply be added as an argument to 'get'
 * and you can add as many arguments as you want, as many handlers as you want
 * they will be parsed from left to right. 
 * the request will travel through them from left to right
 * so the request which reaches getProduct goes in to that 'isAuth' middleware first
 * and in the 'isAuth' middleware, we might be redirecting
 * and we don't call 'next()'
 * hence the request would never continue to that controller action
 * 
 * but if we make it past the if check in ./middelware/isAuth.js file,
 * we do call 'next()', 
 * so that next middleware in line will be called
 * and the next middleware in line would be our 'getAddProduct' controller action here.
 * 
 * and 'isAuth' middleware to all the routes
 * because these routes all require authentication
 * 
 */
router.get('/add-product', isAuth, adminController.getAddProduct);

// /admin/products => GET
router.get('/products', isAuth, adminController.getProducts);

// /admin/add-product => POST
router.post('/add-product', isAuth, adminController.postAddProduct);

router.get('/edit-product/:productId', isAuth, adminController.getEditProduct);

router.post('/edit-product', isAuth, adminController.postEditProduct);

router.post('/delete-product', isAuth, adminController.postDeleteProduct);

module.exports = router;
```

```js
// ./routes/shop.js

const path = require('path');

const express = require('express');

const shopController = require('../controllers/shop');
const isAuth = require('../middleware/is-auth')

const router = express.Router();

router.get('/', shopController.getIndex);

router.get('/products', shopController.getProducts);

router.get('/products/:productId', shopController.getProduct);

router.get('/cart', isAuth, shopController.getCart);

router.post('/cart', isAuth, shopController.postCart);

router.post('/cart-delete-item', isAuth, shopController.postCartDeleteProduct);

router.post('/create-order', isAuth, shopController.postOrder);

router.get('/orders', isAuth, shopController.getOrders);

module.exports = router;

```

\* Chapter 256: Understanding CSRF Attacks
==========================================

![](images/256-understanding-csrf-attacks-1.png)![256-understanding-csrf-attacks-1.png](resources/DABE22443926D7379E90B92203B69FA1.png)

- since you got valid session for that user if you send something to your site, to your server, your sessions is used for that user and therefore that behind the scenes data that the user never sees that configures the money transferal or the order in a certain way that is not OK to the user.

- this part is invisible to the user but the valid session gets used for it because your server is used and therefore this is accepted. this is attack pattern where the session can be stolen where you can abuse the fact the users are logged in and you can simply trick them into making requests which they might not even notice and obviously we wanna protect against this attack pattern

- how we can protect from this is that we wanna ensure that people can only use your session if they are working with your views. so with the views rendered by your application, so that the session is not available on any fake page that might look like your page. but that aren’t your page. and to ensure this, to add this feature, we will use a so-called CSRF token. 

\*Chapter 257: Using A CSRF Token
=================================

1\. update

- app.js

- ./controllers/auth.js

- ./controllers/shop.js

- ./views/includes/navigation.ejs

![](images/257-using-a-csrf-token-1.png)![257-using-a-csrf-token-1.png](resources/23790712AF4196931D7F9E5F29F8133F.png)

- ’npm install —save csurf’ is a package for node-express which allows us to generate a so-called CSRF token. basically a token, a string value, we can embed into our forms, so into our pages for every request that does something on the backend that changes the users state. so anything like ordering something, anything that does something sensitive which we wanna protect against. 

- we can include such a token in our views and on the server, this package will check if the incoming request does have that valid token. 

- how does this protect us? the fake sites might send a request to your backend and they could theoretically use your session but the requests will be missing the token and they can’t guess the token because it’s random hashed value and only one value is valid and the package which runs on the server determines whether a token is valid, so they can’t guess it and they also can steal it because a new token is generated for every page you render. 

![](images/257-using-a-csrf-token-2.png)![257-using-a-csrf-token-2.png](resources/09876F63C61552E68302B158FC1819B8.png)

- let me reload and when inspecting the logout button, you will see that there we also have that input with the value of this token and

![](images/257-using-a-csrf-token-3.png)![257-using-a-csrf-token-3.png](resources/059C95258C79600A5928A7B8E77AE593.png)

- this here is the CSRF token which was generated by the package

![](images/257-using-a-csrf-token-4.png)

![](images/257-using-a-csrf-token-5.png)![257-using-a-csrf-token-4.png](resources/DC7DDEB912CF337CC08E6770E92CA70D.png)![257-using-a-csrf-token-5.png](resources/DE2377C7342B812572C573963C501DE8.png)

- if i click logout, now it works because the package is able to extract that CSRF Token. now it’s not just a session that matters but also the existence of this token.

```js
//app.js

const path = require('path');

const express = require('express');
const bodyParser = require('body-parser');
const mongoose = require('mongoose');
const session = require('express-session');
const MongoDBStore = require('connect-mongodb-session')(session);
const csrf = require('csurf')

const errorController = require('./controllers/error');
const User = require('./models/user');

const MONGODB_URI =
  'mongodb+srv://maximilian:rldnjs12@cluster0-z3vlk.mongodb.net/shop?retryWrites=true';

const app = express();
const store = new MongoDBStore({
  uri: MONGODB_URI,
  collection: 'sessions'
});
/**you can pass an object where you can configure somethings,
 * for example that you wanna store the secret that is used for assigning your token,
 * so for hashing them, that you wanna store them in cookie
 * instead of the session which is the default
 *
 * but i wanna use the session, the default.
 * we don't need to set any of the other values.
 */
const csrfProtection = csrf()

app.set('view engine', 'ejs');
app.set('views', 'views');

const adminRoutes = require('./routes/admin');
const shopRoutes = require('./routes/shop');
const authRoutes = require('./routes/auth');

app.use(bodyParser.urlencoded({ extended: false }));
app.use(express.static(path.join(__dirname, 'public')));
app.use(
  session({
    secret: 'my secret',
    resave: false,
    saveUninitialized: false,
    store: store
  })
);
/**initialize the session.
 * because the package will use that session now.
 * after initializing the session,
 * i will add 'csrfProtection'
 * 
 * csrfProtection is enabled
 * but we still need to add something to our views to use it.
 */
app.use(csrfProtection)

app.use((req, res, next) => {
  if (!req.session.user) {
    return next();
  }
  User.findById(req.session.user._id)
    .then(user => {
      req.user = user;
      next();
    })
    .catch(err => console.log(err));
});

app.use('/admin', adminRoutes);
app.use(shopRoutes);
app.use(authRoutes);

app.use(errorController.get404);

mongoose
  .connect(MONGODB_URI)
  .then(result => {
    app.listen(3000);
  })
  .catch(err => {
    console.log(err);
  });

```

```js
//./controllers/auth.js

const bcrypt = require('bcryptjs');

const User = require('../models/user');

exports.getLogin = (req, res, next) => {
  res.render('auth/login', {
    path: '/login',
    pageTitle: 'Login',
    isAuthenticated: false
  });
};

exports.getSignup = (req, res, next) => {
  res.render('auth/signup', {
    path: '/signup',
    pageTitle: 'Signup',
    isAuthenticated: false
  });
};

exports.postLogin = (req, res, next) => {
  const email = req.body.email;
  const password = req.body.password;
  User.findOne({ email: email })
    .then(user => {
      if (!user) {
        return res.redirect('/login');
      }
      bcrypt
        .compare(password, user.password)
        .then(doMatch => {
          if (doMatch) {
            req.session.isLoggedIn = true;
            req.session.user = user;
            return req.session.save(err => {
              console.log(err);
              res.redirect('/');
            });
          }
          res.redirect('/login');
        })
        .catch(err => {
          console.log(err);
          res.redirect('/login');
        });
    })
    .catch(err => console.log(err));
};

exports.postSignup = (req, res, next) => {
  const email = req.body.email;
  const password = req.body.password;
  const confirmPassword = req.body.confirmPassword;
  User.findOne({ email: email })
    .then(userDoc => {
      if (userDoc) {
        return res.redirect('/signup');
      }
      return bcrypt
        .hash(password, 12)
        .then(hashedPassword => {
          const user = new User({
            email: email,
            password: hashedPassword,
            cart: { items: [] }
          });
          return user.save();
        })
        .then(result => {
          res.redirect('/login');
        });
    })
    .catch(err => {
      console.log(err);
    });
};

/**'Logout' failed because i get an invalid token
 * because logout action was a POST request
 * and for any non-GET request
 * because you change data via POST requests typically
 * for any such requests, 
 * this package will look for the existence of a CSRF token in your views in the request body
 * 
 * to make sure that such a token is there,
 * we first of all need to ensure we have it available in our views
 * to do that, we have to pass data into our view
 */
exports.postLogout = (req, res, next) => {
  req.session.destroy(err => {
    console.log(err);
    res.redirect('/');
  });
};
```

```js
//./controllers/shop.js

const Product = require('../models/product');
const Order = require('../models/order');

exports.getProducts = (req, res, next) => {
  Product.find()
    .then(products => {
      console.log(products);
      res.render('shop/product-list', {
        prods: products,
        pageTitle: 'All Products',
        path: '/products',
        isAuthenticated: req.session.isLoggedIn
      });
    })
    .catch(err => {
      console.log(err);
    });
};

exports.getProduct = (req, res, next) => {
  const prodId = req.params.productId;
  Product.findById(prodId)
    .then(product => {
      res.render('shop/product-detail', {
        product: product,
        pageTitle: product.title,
        path: '/products',
        isAuthenticated: req.session.isLoggedIn
      });
    })
    .catch(err => console.log(err));
};

exports.getIndex = (req, res, next) => {
  Product.find()
    .then(products => {
      res.render('shop/index', {
        prods: products,
        pageTitle: 'Shop',
        path: '/',
        isAuthenticated: req.session.isLoggedIn,
        /**'csrfToken()' is provided by the CSRF middleware which we added by this package. 
         * this will genearte such a token
         * and we will store it in CSRF token which we then can use in our view
         */
        csrfToken: req.csrfToken()
      });
    })
    .catch(err => {
      console.log(err);
    });
};

exports.getCart = (req, res, next) => {
  req.user
    .populate('cart.items.productId')
    .execPopulate()
    .then(user => {
      const products = user.cart.items;
      res.render('shop/cart', {
        path: '/cart',
        pageTitle: 'Your Cart',
        products: products,
        isAuthenticated: req.session.isLoggedIn
      });
    })
    .catch(err => console.log(err));
};

exports.postCart = (req, res, next) => {
  const prodId = req.body.productId;
  Product.findById(prodId)
    .then(product => {
      return req.user.addToCart(product);
    })
    .then(result => {
      console.log(result);
      res.redirect('/cart');
    });
};

exports.postCartDeleteProduct = (req, res, next) => {
  const prodId = req.body.productId;
  req.user
    .removeFromCart(prodId)
    .then(result => {
      res.redirect('/cart');
    })
    .catch(err => console.log(err));
};

exports.postOrder = (req, res, next) => {
  req.user
    .populate('cart.items.productId')
    .execPopulate()
    .then(user => {
      const products = user.cart.items.map(i => {
        return { quantity: i.quantity, product: { ...i.productId._doc } };
      });
      const order = new Order({
        user: {
          name: req.user.name,
          userId: req.user
        },
        products: products
      });
      return order.save();
    })
    .then(result => {
      return req.user.clearCart();
    })
    .then(() => {
      res.redirect('/orders');
    })
    .catch(err => console.log(err));
};

exports.getOrders = (req, res, next) => {
  Order.find({ 'user.userId': req.user._id })
    .then(orders => {
      res.render('shop/orders', {
        path: '/orders',
        pageTitle: 'Your Orders',
        orders: orders,
        isAuthenticated: req.session.isLoggedIn
      });
    })
    .catch(err => console.log(err));
};


```

```js
<!--./views/includes/navigation.ejs-->

<div class="backdrop"></div>
<header class="main-header">
    <button id="side-menu-toggle">Menu</button>
    <nav class="main-header__nav">
        <ul class="main-header__item-list">
            <li class="main-header__item">
                <a class="<%= path === '/' ? 'active' : '' %>" href="/">Shop</a>
            </li>
            <li class="main-header__item">
                <a class="<%= path === '/products' ? 'active' : '' %>" href="/products">Products</a>
            </li>
            <% if (isAuthenticated) { %>
                <li class="main-header__item">
                    <a class="<%= path === '/cart' ? 'active' : '' %>" href="/cart">Cart</a>
                </li>
                <li class="main-header__item">
                    <a class="<%= path === '/orders' ? 'active' : '' %>" href="/orders">Orders</a>
                </li>
                <li class="main-header__item">
                    <a class="<%= path === '/admin/add-product' ? 'active' : '' %>" href="/admin/add-product">Add Product
                    </a>
                </li>
                <li class="main-header__item">
                    <a class="<%= path === '/admin/products' ? 'active' : '' %>" href="/admin/products">Admin Products
                    </a>
                </li>
            <% } %>
        </ul>
        <ul class="main-header__item-list">
            <% if (!isAuthenticated) { %>
                <li class="main-header__item">
                    <a class="<%= path === '/login' ? 'active' : '' %>" href="/login">Login</a>
                </li>
                <li class="main-header__item">
                    <a class="<%= path === '/signup' ? 'active' : '' %>" href="/signup">Signup</a>
                </li>
            <% } else { %>
                <li class="main-header__item">
                    <form action="/logout" method="post">
                        <!--
                        'csrfToken' in here is in 'getIndex()' in ./controllers/shop.js
                        we have to give this a name and the name has to be '_csrf'
                        because the package which we added will look for this name

                        the same should be done in the mobile logout button
                        -->
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <button type="submit">Logout</button>
                    </form>
                </li>
            <% } %>
        </ul>
    </nav>
</header>

<nav class="mobile-nav">
    <ul class="mobile-nav__item-list">
        <li class="mobile-nav__item">
            <a class="<%= path === '/' ? 'active' : '' %>" href="/">Shop</a>
        </li>
        <li class="mobile-nav__item">
            <a class="<%= path === '/products' ? 'active' : '' %>" href="/products">Products</a>
        </li>
        <% if (isAuthenticated) { %>
            <li class="mobile-nav__item">
                <a class="<%= path === '/cart' ? 'active' : '' %>" href="/cart">Cart</a>
            </li>
            <li class="mobile-nav__item">
                <a class="<%= path === '/orders' ? 'active' : '' %>" href="/orders">Orders</a>
            </li>
            <li class="mobile-nav__item">
                <a class="<%= path === '/admin/add-product' ? 'active' : '' %>" href="/admin/add-product">Add Product
                </a>
            </li>
            <li class="mobile-nav__item">
                <a class="<%= path === '/admin/products' ? 'active' : '' %>" href="/admin/products">Admin Products
                </a>
            </li>
        <% } %>
        <% if (!isAuthenticated) { %>
            <li class="mobile-nav__item">
                <a class="<%= path === '/login' ? 'active' : '' %>" href="/login">Login</a>
            </li>
            <li class="mobile-nav__item">
                <a class="<%= path === '/signup' ? 'active' : '' %>" href="/signup">Signup</a>
            </li>
        <% } else { %>
            <li class="mobile-nav__item">
                <form action="/logout" method="post">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <button type="submit">Logout</button>
                </form>
            </li>
        <% } %>
    </ul>
</nav>
```

\* Chapter 258: Adding CSRF Protection
======================================

1\. update

- ./controllers/shop.js

- app.js

- ./views/includes/navigation.ejs

- ./views/includes/add-to-cart.ejs

- ./views/admin/edit-product.ejs

- ./views/auth/login.ejs

- ./views/auth/signup.ejs

- ./views/admin/product.ejs

- ./views/shop/cart.ejs

![](images/258-adding-csrf-protection-1.png)

![](images/258-adding-csrf-protection-2.png)

![](images/258-adding-csrf-protection-3.png)

![](images/258-adding-csrf-protection-4.png)

![](images/258-adding-csrf-protection-5.png)

![](images/258-adding-csrf-protection-6.png)![258-adding-csrf-protection-1.png](resources/A94C4F60390752A07BA7169B0F79ED01.png)![258-adding-csrf-protection-2.png](resources/62EB90610C1D10272D8B1FCF1E57B0FC.png)![258-adding-csrf-protection-3.png](resources/F81A55A19560B2D742860006C730129C.png)![258-adding-csrf-protection-4.png](resources/B6893B350E3B12EB233A25261E24C2A9.png)![258-adding-csrf-protection-5.png](resources/C4070FC85FC5CA02B9359C01D0297707.png)![258-adding-csrf-protection-6.png](resources/38B97952728F90C9E6791BF6D890F113.png)

- this CSRF Protection is the crucial thing which you have to add to any production ready application, it’s not optional. otherwise you will have a huge security issue on your page. you need to add this to ensure that your sessions don’t get stolen.

```js
//app.js

const path = require('path');

const express = require('express');
const bodyParser = require('body-parser');
const mongoose = require('mongoose');
const session = require('express-session');
const MongoDBStore = require('connect-mongodb-session')(session);
const csrf = require('csurf')

const errorController = require('./controllers/error');
const User = require('./models/user');

const MONGODB_URI =
  'mongodb+srv://maximilian:rldnjs12@cluster0-z3vlk.mongodb.net/shop?retryWrites=true';

const app = express();
const store = new MongoDBStore({
  uri: MONGODB_URI,
  collection: 'sessions'
});
/**you can pass an object where you can configure somethings,
 * for example that you wanna store the secret that is used for assigning your token,
 * so for hashing them, that you wanna store them in cookie
 * instead of the session which is the default
 *
 * but i wanna use the session, the default.
 * we don't need to set any of the other values.
 */
const csrfProtection = csrf()

app.set('view engine', 'ejs');
app.set('views', 'views');

const adminRoutes = require('./routes/admin');
const shopRoutes = require('./routes/shop');
const authRoutes = require('./routes/auth');

app.use(bodyParser.urlencoded({ extended: false }));
app.use(express.static(path.join(__dirname, 'public')));
app.use(
  session({
    secret: 'my secret',
    resave: false,
    saveUninitialized: false,
    store: store
  })
);
/**initialize the session.
 * because the package will use that session now.
 * after initializing the session,
 * i will add 'csrfProtection'
 * 
 * csrfProtection is enabled
 * but we still need to add something to our views to use it.
 */
app.use(csrfProtection)

app.use((req, res, next) => {
  if (!req.session.user) {
    return next();
  }
  User.findById(req.session.user._id)
    .then(user => {
      req.user = user;
      next();
    })
    .catch(err => console.log(err));
});

app.use((req, res, next) => {
  /**we can use a special feature provided by Express.js
   * we can access a special field on the response, the 'locals' field
   * this allows us to set local variables that are passed into the views,
   * because they will only exist in the views which are rendered. 
   * 
   * so now for every requst that is executed,
   * these 2 fields will be set for the views that are rendered
   * 
   * then we have to call 'next()'
   * so that we are able to continue
   */
  res.locals.isAuthenticated = req.session.isLoggedIn
  res.locals.csrfToken = req.csrfToken()
  next()
})

app.use('/admin', adminRoutes);
app.use(shopRoutes);
app.use(authRoutes);

app.use(errorController.get404);

mongoose
  .connect(MONGODB_URI)
  .then(result => {
    app.listen(3000);
  })
  .catch(err => {
    console.log(err);
  });

```

```js
//./controllers/shop.js

const Product = require('../models/product');
const Order = require('../models/order');

exports.getProducts = (req, res, next) => {
  Product.find()
    .then(products => {
      console.log(products);
      res.render('shop/product-list', {
        prods: products,
        pageTitle: 'All Products',
        path: '/products',
        isAuthenticated: req.session.isLoggedIn
      });
    })
    .catch(err => {
      console.log(err);
    });
};

exports.getProduct = (req, res, next) => {
  const prodId = req.params.productId;
  Product.findById(prodId)
    .then(product => {
      res.render('shop/product-detail', {
        product: product,
        pageTitle: product.title,
        path: '/products',
        isAuthenticated: req.session.isLoggedIn
      });
    })
    .catch(err => console.log(err));
};

exports.getIndex = (req, res, next) => {
  Product.find()
    .then(products => {
      res.render('shop/index', {
        prods: products,
        pageTitle: 'Shop',
        path: '/'
        /**tell express.js that this is now totally unrelated from CSRF thing,
         * tell express.js that we have some data that should be included in every rendered view
         * we will do this in app.js
         */
      });
    })
    .catch(err => {
      console.log(err);
    });
};

exports.getCart = (req, res, next) => {
  req.user
    .populate('cart.items.productId')
    .execPopulate()
    .then(user => {
      const products = user.cart.items;
      res.render('shop/cart', {
        path: '/cart',
        pageTitle: 'Your Cart',
        products: products,
        isAuthenticated: req.session.isLoggedIn
      });
    })
    .catch(err => console.log(err));
};

exports.postCart = (req, res, next) => {
  const prodId = req.body.productId;
  Product.findById(prodId)
    .then(product => {
      return req.user.addToCart(product);
    })
    .then(result => {
      console.log(result);
      res.redirect('/cart');
    });
};

exports.postCartDeleteProduct = (req, res, next) => {
  const prodId = req.body.productId;
  req.user
    .removeFromCart(prodId)
    .then(result => {
      res.redirect('/cart');
    })
    .catch(err => console.log(err));
};

exports.postOrder = (req, res, next) => {
  req.user
    .populate('cart.items.productId')
    .execPopulate()
    .then(user => {
      const products = user.cart.items.map(i => {
        return { quantity: i.quantity, product: { ...i.productId._doc } };
      });
      const order = new Order({
        user: {
          name: req.user.name,
          userId: req.user
        },
        products: products
      });
      return order.save();
    })
    .then(result => {
      return req.user.clearCart();
    })
    .then(() => {
      res.redirect('/orders');
    })
    .catch(err => console.log(err));
};

exports.getOrders = (req, res, next) => {
  Order.find({ 'user.userId': req.user._id })
    .then(orders => {
      res.render('shop/orders', {
        path: '/orders',
        pageTitle: 'Your Orders',
        orders: orders,
        isAuthenticated: req.session.isLoggedIn
      });
    })
    .catch(err => console.log(err));
};


```

```js
<!--./views/includes/navigation.ejs-->

<div class="backdrop"></div>
<header class="main-header">
    <button id="side-menu-toggle">Menu</button>
    <nav class="main-header__nav">
        <ul class="main-header__item-list">
            <li class="main-header__item">
                <a class="<%= path === '/' ? 'active' : '' %>" href="/">Shop</a>
            </li>
            <li class="main-header__item">
                <a class="<%= path === '/products' ? 'active' : '' %>" href="/products">Products</a>
            </li>
            <% if (isAuthenticated) { %>
                <li class="main-header__item">
                    <a class="<%= path === '/cart' ? 'active' : '' %>" href="/cart">Cart</a>
                </li>
                <li class="main-header__item">
                    <a class="<%= path === '/orders' ? 'active' : '' %>" href="/orders">Orders</a>
                </li>
                <li class="main-header__item">
                    <a class="<%= path === '/admin/add-product' ? 'active' : '' %>" href="/admin/add-product">Add Product
                    </a>
                </li>
                <li class="main-header__item">
                    <a class="<%= path === '/admin/products' ? 'active' : '' %>" href="/admin/products">Admin Products
                    </a>
                </li>
            <% } %>
        </ul>
        <ul class="main-header__item-list">
            <% if (!isAuthenticated) { %>
                <li class="main-header__item">
                    <a class="<%= path === '/login' ? 'active' : '' %>" href="/login">Login</a>
                </li>
                <li class="main-header__item">
                    <a class="<%= path === '/signup' ? 'active' : '' %>" href="/signup">Signup</a>
                </li>
            <% } else { %>
                <li class="main-header__item">
                    <form action="/logout" method="post">
                        <!--
                        'csrfToken' in here is in 'getIndex()' in ./controllers/shop.js
                        we have to give this a name and the name has to be '_csrf'
                        because the package which we added will look for this name

                        the same should be done in the mobile logout button
                        -->
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <button type="submit">Logout</button>
                    </form>
                </li>
            <% } %>
        </ul>
    </nav>
</header>

<nav class="mobile-nav">
    <ul class="mobile-nav__item-list">
        <li class="mobile-nav__item">
            <a class="<%= path === '/' ? 'active' : '' %>" href="/">Shop</a>
        </li>
        <li class="mobile-nav__item">
            <a class="<%= path === '/products' ? 'active' : '' %>" href="/products">Products</a>
        </li>
        <% if (isAuthenticated) { %>
            <li class="mobile-nav__item">
                <a class="<%= path === '/cart' ? 'active' : '' %>" href="/cart">Cart</a>
            </li>
            <li class="mobile-nav__item">
                <a class="<%= path === '/orders' ? 'active' : '' %>" href="/orders">Orders</a>
            </li>
            <li class="mobile-nav__item">
                <a class="<%= path === '/admin/add-product' ? 'active' : '' %>" href="/admin/add-product">Add Product
                </a>
            </li>
            <li class="mobile-nav__item">
                <a class="<%= path === '/admin/products' ? 'active' : '' %>" href="/admin/products">Admin Products
                </a>
            </li>
        <% } %>
        <% if (!isAuthenticated) { %>
            <li class="mobile-nav__item">
                <a class="<%= path === '/login' ? 'active' : '' %>" href="/login">Login</a>
            </li>
            <li class="mobile-nav__item">
                 <a class="<%= path === '/signup' ? 'active' : '' %>" href="/signup">Signup</a>
            </li>
        <% } else { %>
            <li class="mobile-nav__item">
                <form action="/logout" method="post">
                    <!--
                        '<input type="hidden" name="_csrf" value="<%= csrfToken %>">'
                        this should be input to every views(ejs file) which have POST request
                    -->
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <button type="submit">Logout</button>
                </form>
            </li>
        <% } %>
    </ul>
</nav>
```

```js
<!--./views/includes/add-to-cart.ejs-->

<form action="/cart" method="post">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <button class="btn" type="submit">Add to Cart</button>
    <input type="hidden" name="productId" value="<%= product._id %>">
</form>
```

```js
<!--./views/admin/edit-product.ejs-->

<%- include('../includes/head.ejs') %>
    <link rel="stylesheet" href="/css/forms.css">
    <link rel="stylesheet" href="/css/product.css">
</head>

<body>
   <%- include('../includes/navigation.ejs') %>

    <main>
        <form class="product-form" action="/admin/<% if (editing) { %>edit-product<% } else { %>add-product<% } %>" method="POST">
            <div class="form-control">
                <label for="title">Title</label>
                <input type="text" name="title" id="title" value="<% if (editing) { %><%= product.title %><% } %>">
            </div>
            <div class="form-control">
                <label for="imageUrl">Image URL</label>
                <input type="text" name="imageUrl" id="imageUrl" value="<% if (editing) { %><%= product.imageUrl %><% } %>">
            </div>
            <div class="form-control">
                <label for="price">Price</label>
                <input type="number" name="price" id="price" step="0.01" value="<% if (editing) { %><%= product.price %><% } %>">
            </div>
            <div class="form-control">
                <label for="description">Description</label>
                <textarea name="description" id="description" rows="5"><% if (editing) { %><%= product.description %><% } %></textarea>
            </div>
            <% if (editing) { %>
                <input type="hidden" value="<%= product._id %>" name="productId">
            <% } %>

            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <button class="btn" type="submit"><% if (editing) { %>Update Product<% } else { %>Add Product<% } %></button>
        </form>
    </main>
<%- include('../includes/end.ejs') %>
```

```js
<!--./views/auth/login.ejs-->

<%- include('../includes/head.ejs') %>
    <link rel="stylesheet" href="/css/forms.css">
    <link rel="stylesheet" href="/css/auth.css">
</head>

<body>
   <%- include('../includes/navigation.ejs') %>

    <main>
        <form class="login-form" action="/login" method="POST">
            <div class="form-control">
                <label for="email">E-Mail</label>
                <input type="email" name="email" id="email">
            </div>
            <div class="form-control">
                <label for="password">Password</label>
                <input type="password" name="password" id="password">
            </div>
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <button class="btn" type="submit">Login</button>
        </form>
    </main>
<%- include('../includes/end.ejs') %>
```

```js
<!--./views/auth/signup.ejs-->

<%- include('../includes/head.ejs') %>
    <link rel="stylesheet" href="/css/forms.css">
    <link rel="stylesheet" href="/css/auth.css">
</head>

<body>
   <%- include('../includes/navigation.ejs') %>

    <main>
        <form class="login-form" action="/signup" method="POST">
            <div class="form-control">
                <label for="email">E-Mail</label>
                <input type="email" name="email" id="email">
            </div>
            <div class="form-control">
                <label for="password">Password</label>
                <input type="password" name="password" id="password">
            </div>
            <div class="form-control">
                <label for="confirmPassword">Confirm Password</label>
                <input type="password" name="confirmPassword" id="confirmPassword">
            </div>
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <button class="btn" type="submit">Signup</button>
        </form>
    </main>
<%- include('../includes/end.ejs') %>
```

```js
<!--./views/admin/products.ejs-->

<%- include('../includes/head.ejs') %>
    <link rel="stylesheet" href="/css/product.css">
    </head>

    <body>
        <%- include('../includes/navigation.ejs') %>

            <main>
                <% if (prods.length > 0) { %>
                    <div class="grid">
                        <% for (let product of prods) { %>
                            <article class="card product-item">
                                <header class="card__header">
                                    <h1 class="product__title">
                                        <%= product.title %>
                                    </h1>
                                </header>
                                <div class="card__image">
                                    <img src="<%= product.imageUrl %>" alt="<%= product.title %>">
                                </div>
                                <div class="card__content">
                                    <h2 class="product__price">$
                                        <%= product.price %>
                                    </h2>
                                    <p class="product__description">
                                        <%= product.description %>
                                    </p>
                                </div>
                                <div class="card__actions">
                                    <a href="/admin/edit-product/<%= product._id %>?edit=true" class="btn">Edit</a>
                                    <form action="/admin/delete-product" method="POST">
                                        <input type="hidden" value="<%= product._id %>" name="productId">
                                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                        <button class="btn" type="submit">Delete</button>
                                    </form>

                                </div>
                            </article>
                            <% } %>
                    </div>
                    <% } else { %>
                        <h1>No Products Found!</h1>
                        <% } %>
            </main>
            <%- include('../includes/end.ejs') %>
```

```js
<!--./views/shop/cart.ejs-->

<%- include('../includes/head.ejs') %>
    <link rel="stylesheet" href="/css/cart.css">
    </head>

    <body>
        <%- include('../includes/navigation.ejs') %>
        <main>
            <% if (products.length > 0) { %>
                <ul class="cart__item-list">
                    <% products.forEach(p => { %>
                        <li class="cart__item">
                            <h1><%= p.productId.title %></h1>
                            <h2>Quantity: <%= p.quantity %></h2>
                            <form action="/cart-delete-item" method="POST">
                                <input type="hidden" value="<%= p.productId._id %>" name="productId">
                                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                <button class="btn danger" type="submit">Delete</button>
                            </form>
                        </li>
                    <% }) %>
                </ul>
                <hr>
                <div class="centered">
                    <form action="/create-order" method="POST">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <button type="submit" class="btn">Order Now!</button>
                    </form>
                </div>
                
            <% } else { %>
                <h1>No Products in Cart!</h1>
            <% } %>
        </main>
        <%- include('../includes/end.ejs') %>
```

\* Chapter 259: Fixing The Order Button
=======================================

1\. update

- ./controllers/shop.js

- ./models/order.js

![](images/259-fixing-the-order-button-1.png)

![](images/259-fixing-the-order-button-2.png)

![](images/259-fixing-the-order-button-3.png)

![](images/259-fixing-the-order-button-4.png)

![](images/259-fixing-the-order-button-5.png)

![](images/259-fixing-the-order-button-6.png)

![](images/259-fixing-the-order-button-7.png)

![](images/259-fixing-the-order-button-8.png)![259-fixing-the-order-button-1.png](resources/CF1F6C8045567F44470452B6B3A152E7.png)![259-fixing-the-order-button-2.png](resources/41093860308DF88D70DBF3C65ACD71D6.png)![259-fixing-the-order-button-3.png](resources/50F6761C7B22E9EC0F53FF463FED01C7.png)![259-fixing-the-order-button-4.png](resources/21476A3C2C2ED076DF5AD73C113ECCB2.png)![259-fixing-the-order-button-5.png](resources/FB8917C75AEBE5BED9AE8F11306F1EC1.png)![259-fixing-the-order-button-6.png](resources/AABA9B96797F3C409484D3C452AC195D.png)![259-fixing-the-order-button-7.png](resources/E1EFCA4F2ED59F5BFC51EF2C5829BF7C.png)![259-fixing-the-order-button-8.png](resources/D6C0436F6354558D0D3EA2E04B0D0B96.png)

```js
//./controllers/shop.js

const Product = require('../models/product');
const Order = require('../models/order');

exports.getProducts = (req, res, next) => {
  Product.find()
    .then(products => {
      console.log(products);
      res.render('shop/product-list', {
        prods: products,
        pageTitle: 'All Products',
        path: '/products',
        isAuthenticated: req.session.isLoggedIn
      });
    })
    .catch(err => {
      console.log(err);
    });
};

exports.getProduct = (req, res, next) => {
  const prodId = req.params.productId;
  Product.findById(prodId)
    .then(product => {
      res.render('shop/product-detail', {
        product: product,
        pageTitle: product.title,
        path: '/products',
        isAuthenticated: req.session.isLoggedIn
      });
    })
    .catch(err => console.log(err));
};

exports.getIndex = (req, res, next) => {
  Product.find()
    .then(products => {
      res.render('shop/index', {
        prods: products,
        pageTitle: 'Shop',
        path: '/'
      });
    })
    .catch(err => {
      console.log(err);
    });
};

exports.getCart = (req, res, next) => {
  req.user
    .populate('cart.items.productId')
    .execPopulate()
    .then(user => {
      const products = user.cart.items;
      res.render('shop/cart', {
        path: '/cart',
        pageTitle: 'Your Cart',
        products: products,
        isAuthenticated: req.session.isLoggedIn
      });
    })
    .catch(err => console.log(err));
};

exports.postCart = (req, res, next) => {
  const prodId = req.body.productId;
  Product.findById(prodId)
    .then(product => {
      return req.user.addToCart(product);
    })
    .then(result => {
      console.log(result);
      res.redirect('/cart');
    });
};

exports.postCartDeleteProduct = (req, res, next) => {
  const prodId = req.body.productId;
  req.user
    .removeFromCart(prodId)
    .then(result => {
      res.redirect('/cart');
    })
    .catch(err => console.log(err));
};

exports.postOrder = (req, res, next) => {
  req.user
    .populate('cart.items.productId')
    .execPopulate()
    .then(user => {
      const products = user.cart.items.map(i => {
        return { quantity: i.quantity, product: { ...i.productId._doc } };
      });
      const order = new Order({
        user: {
          email: req.user.email,
          userId: req.user
        },
        products: products
      });
      return order.save();
    })
    .then(result => {
      return req.user.clearCart();
    })
    .then(() => {
      res.redirect('/orders');
    })
    .catch(err => console.log(err));
};

exports.getOrders = (req, res, next) => {
  Order.find({ 'user.userId': req.user._id })
    .then(orders => {
      res.render('shop/orders', {
        path: '/orders',
        pageTitle: 'Your Orders',
        orders: orders,
        isAuthenticated: req.session.isLoggedIn
      });
    })
    .catch(err => console.log(err));
};


```

```js
// ./models/order.js

const mongoose = require('mongoose');

const Schema = mongoose.Schema;

const orderSchema = new Schema({
  products: [
    {
      product: { type: Object, required: true },
      quantity: { type: Number, required: true }
    }
  ],
  user: {
    email: {
      type: String,
      required: true
    },
    userId: {
      type: Schema.Types.ObjectId,
      required: true,
      ref: 'User'
    }
  }
});

module.exports = mongoose.model('Order', orderSchema);

```

\* Chapter 260: Providing User Feedback
=======================================

1\. update

- ./controllers/auth.js

- ./controllers/admin.js

- ./controllers/shop.js

- app.js

- ./views/auth/login.ejs

![](images/260-providing-user-feedback-1.png)![260-providing-user-feedback-1.png](resources/88878CE2E0B79E11EB7757E110FE0268.png)

- if we wanna pass some data into the rendered view when we are redirecting as we are doing it here because upon a redirect, technically a new request is started, a new request to '/login' in this case. we don't know that we got here because the user entered an invalid email or anything like that when we triggered this request, this is treated in the same way as a request that was triggered by clicking on the login button in our menu 

- so we have no way of finding out if we wanna display an error message or not. to solve that problem and store some data before we redirect which we then use in the brand new request that is triggered by the redirect how could we do that?

- if you wanna store data across requests, you need a session. so we can use a session here but i don't wanna store the error message in the session permanently. i wanna add something to the error message, kind of flash it onto the session. and once the error message was then used, so once we pull it out of the session and did something with it. i wanna remove it from the session. so that for the subsequent requests, this error message is not part of the session anymore for that we can use another package called 'connect-flash’

- ’npm install —save connect-flash’

![](images/260-providing-user-feedback-2.png)

![](images/260-providing-user-feedback-3.png)![260-providing-user-feedback-2.png](resources/4C1205989BD9A826290F50687AD9E904.png)![260-providing-user-feedback-3.png](resources/7BECFAE8FE39C48230AF7E83E9529EE1.png)

- let me enter an invalid email, i see invalid e-mail or password.

![](images/260-providing-user-feedback-4.png)

![](images/260-providing-user-feedback-5.png)![260-providing-user-feedback-4.png](resources/DD276F7ECE96CF3857D58D18222D3166.png)![260-providing-user-feedback-5.png](resources/69D62CB6A976A76F5470EEA8CF2DB74E.png)

- if i enter a valid email but an invalid password, i don’t see any error message because i don’t flash anything onto my session yet.

```js
//./controllers/auth.js

const bcrypt = require('bcryptjs');

const User = require('../models/user');

exports.getLogin = (req, res, next) => {
  res.render('auth/login', {
    path: '/login',
    pageTitle: 'Login',
    /**we now access the key for which we wanna to get the message 
     * whatever i stored in error will be retrieved and stored in error message
     * and thereafter, this information is removed from the session.
     * 
     * so 'errorMessage' will be set and will hold a value 
     * only if we have an error flashed into our session
    */
    errorMessage: req.flash('error')
  });
};

exports.getSignup = (req, res, next) => {
  res.render('auth/signup', {
    path: '/signup',
    pageTitle: 'Signup'
  });
};

exports.postLogin = (req, res, next) => {
  const email = req.body.email;
  const password = req.body.password;
  User.findOne({ email: email })
    .then(user => {
      if (!user) {
        /**'flash()' takes a key under which this message will be stored
         * we cound name this 'error' and the message
         * and in this case, this would be invalid e-mail or password
         */
        req.flash('error', 'Invalid email or password.')
        return res.redirect('/login');
      }
      bcrypt
        .compare(password, user.password)
        .then(doMatch => {
          if (doMatch) {
            req.session.isLoggedIn = true;
            req.session.user = user;
            return req.session.save(err => {
              console.log(err);
              res.redirect('/');
            });
          }
          res.redirect('/login');
        })
        .catch(err => {
          console.log(err);
          res.redirect('/login');
        });
    })
    .catch(err => console.log(err));
};

exports.postSignup = (req, res, next) => {
  const email = req.body.email;
  const password = req.body.password;
  const confirmPassword = req.body.confirmPassword;
  User.findOne({ email: email })
    .then(userDoc => {
      if (userDoc) {
        return res.redirect('/signup');
      }
      return bcrypt
        .hash(password, 12)
        .then(hashedPassword => {
          const user = new User({
            email: email,
            password: hashedPassword,
            cart: { items: [] }
          });
          return user.save();
        })
        .then(result => {
          res.redirect('/login');
        });
    })
    .catch(err => {
      console.log(err);
    });
};

exports.postLogout = (req, res, next) => {
  req.session.destroy(err => {
    console.log(err);
    res.redirect('/');
  });
};
```

```js
// ./controllers/admin.js

const Product = require('../models/product');

exports.getAddProduct = (req, res, next) => {
  res.render('admin/edit-product', {
    pageTitle: 'Add Product',
    path: '/admin/add-product',
    editing: false
  });
};

exports.postAddProduct = (req, res, next) => {
  const title = req.body.title;
  const imageUrl = req.body.imageUrl;
  const price = req.body.price;
  const description = req.body.description;
  const product = new Product({
    title: title,
    price: price,
    description: description,
    imageUrl: imageUrl,
    userId: req.user
  });
  product
    .save()
    .then(result => {
      // console.log(result);
      console.log('Created Product');
      res.redirect('/admin/products');
    })
    .catch(err => {
      console.log(err);
    });
};

exports.getEditProduct = (req, res, next) => {
  const editMode = req.query.edit;
  if (!editMode) {
    return res.redirect('/');
  }
  const prodId = req.params.productId;
  Product.findById(prodId)
    .then(product => {
      if (!product) {
        return res.redirect('/');
      }
      res.render('admin/edit-product', {
        pageTitle: 'Edit Product',
        path: '/admin/edit-product',
        editing: editMode,
        product: product
        });
    })
    .catch(err => console.log(err));
};

exports.postEditProduct = (req, res, next) => {
  const prodId = req.body.productId;
  const updatedTitle = req.body.title;
  const updatedPrice = req.body.price;
  const updatedImageUrl = req.body.imageUrl;
  const updatedDesc = req.body.description;

  Product.findById(prodId)
    .then(product => {
      product.title = updatedTitle;
      product.price = updatedPrice;
      product.description = updatedDesc;
      product.imageUrl = updatedImageUrl;
      return product.save();
    })
    .then(result => {
      console.log('UPDATED PRODUCT!');
      res.redirect('/admin/products');
    })
    .catch(err => console.log(err));
};

exports.getProducts = (req, res, next) => {
  Product.find()
    // .select('title price -_id')
    // .populate('userId', 'name')
    .then(products => {
      console.log(products);
      res.render('admin/products', {
        prods: products,
        pageTitle: 'Admin Products',
        path: '/admin/products'
      });
    })
    .catch(err => console.log(err));
};

exports.postDeleteProduct = (req, res, next) => {
  const prodId = req.body.productId;
  Product.findByIdAndRemove(prodId)
    .then(() => {
      console.log('DESTROYED PRODUCT');
      res.redirect('/admin/products');
    })
    .catch(err => console.log(err));
};

```

```js
//./controllers/shop.js

const Product = require('../models/product');
const Order = require('../models/order');

exports.getProducts = (req, res, next) => {
  Product.find()
    .then(products => {
      console.log(products);
      res.render('shop/product-list', {
        prods: products,
        pageTitle: 'All Products',
        path: '/products'
      });
    })
    .catch(err => {
      console.log(err);
    });
};

exports.getProduct = (req, res, next) => {
  const prodId = req.params.productId;
  Product.findById(prodId)
    .then(product => {
      res.render('shop/product-detail', {
        product: product,
        pageTitle: product.title,
        path: '/products'
      });
    })
    .catch(err => console.log(err));
};

exports.getIndex = (req, res, next) => {
  Product.find()
    .then(products => {
      res.render('shop/index', {
        prods: products,
        pageTitle: 'Shop',
        path: '/'
      });
    })
    .catch(err => {
      console.log(err);
    });
};

exports.getCart = (req, res, next) => {
  req.user
    .populate('cart.items.productId')
    .execPopulate()
    .then(user => {
      const products = user.cart.items;
      res.render('shop/cart', {
        path: '/cart',
        pageTitle: 'Your Cart',
        products: products
      });
    })
    .catch(err => console.log(err));
};

exports.postCart = (req, res, next) => {
  const prodId = req.body.productId;
  Product.findById(prodId)
    .then(product => {
      return req.user.addToCart(product);
    })
    .then(result => {
      console.log(result);
      res.redirect('/cart');
    });
};

exports.postCartDeleteProduct = (req, res, next) => {
  const prodId = req.body.productId;
  req.user
    .removeFromCart(prodId)
    .then(result => {
      res.redirect('/cart');
    })
    .catch(err => console.log(err));
};

exports.postOrder = (req, res, next) => {
  req.user
    .populate('cart.items.productId')
    .execPopulate()
    .then(user => {
      const products = user.cart.items.map(i => {
        return { quantity: i.quantity, product: { ...i.productId._doc } };
      });
      const order = new Order({
        user: {
          email: req.user.email,
          userId: req.user
        },
        products: products
      });
      return order.save();
    })
    .then(result => {
      return req.user.clearCart();
    })
    .then(() => {
      res.redirect('/orders');
    })
    .catch(err => console.log(err));
};

exports.getOrders = (req, res, next) => {
  Order.find({ 'user.userId': req.user._id })
    .then(orders => {
      res.render('shop/orders', {
        path: '/orders',
        pageTitle: 'Your Orders',
        orders: orders
      });
    })
    .catch(err => console.log(err));
};


```

```js
//app.js

const path = require('path');

const express = require('express');
const bodyParser = require('body-parser');
const mongoose = require('mongoose');
const session = require('express-session');
const MongoDBStore = require('connect-mongodb-session')(session);
const csrf = require('csurf')
const flash = require('connect-flash')

const errorController = require('./controllers/error');
const User = require('./models/user');

const MONGODB_URI =
  'mongodb+srv://maximilian:rldnjs12@cluster0-z3vlk.mongodb.net/shop?retryWrites=true';

const app = express();
const store = new MongoDBStore({
  uri: MONGODB_URI,
  collection: 'sessions'
});
const csrfProtection = csrf()

app.set('view engine', 'ejs');
app.set('views', 'views');

const adminRoutes = require('./routes/admin');
const shopRoutes = require('./routes/shop');
const authRoutes = require('./routes/auth');

app.use(bodyParser.urlencoded({ extended: false }));
app.use(express.static(path.join(__dirname, 'public')));
app.use(
  session({
    secret: 'my secret',
    resave: false,
    saveUninitialized: false,
    store: store
  })
);
app.use(csrfProtection)
/**now we can use that flash middleware anywhere in our application on the request object */
app.use(flash())

app.use((req, res, next) => {
  if (!req.session.user) {
    return next();
  }
  User.findById(req.session.user._id)
    .then(user => {
      req.user = user;
      next();
    })
    .catch(err => console.log(err));
});

app.use((req, res, next) => {
  res.locals.isAuthenticated = req.session.isLoggedIn
  res.locals.csrfToken = req.csrfToken()
  next()
})

app.use('/admin', adminRoutes);
app.use(shopRoutes);
app.use(authRoutes);

app.use(errorController.get404);

mongoose
  .connect(MONGODB_URI)
  .then(result => {
    app.listen(3000);
  })
  .catch(err => {
    console.log(err);
  });

```

```js
<!--./views/auth/login.ejs-->

<%- include('../includes/head.ejs') %>
    <link rel="stylesheet" href="/css/forms.css">
    <link rel="stylesheet" href="/css/auth.css">
</head>

<body>
   <%- include('../includes/navigation.ejs') %>

    <main>
        <% if (errorMessage) { %>
        <div><%= errorMessage %></div>
        <% } %>
        <form class="login-form" action="/login" method="POST">
            <div class="form-control">
                <label for="email">E-Mail</label>
                <input type="email" name="email" id="email">
            </div>
            <div class="form-control">
                <label for="password">Password</label>
                <input type="password" name="password" id="password">
            </div>
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <button class="btn" type="submit">Login</button>
        </form>
    </main>
<%- include('../includes/end.ejs') %>
```

\* Chapter 261: Optional: Styling Error Messages
================================================

![](images/261-optional-styling-error-messages-1.png)

![](images/261-optional-styling-error-messages-2.png)![261-optional-styling-error-messages-1.png](resources/633056657137EC7D24CF7018B4101443.png)![261-optional-styling-error-messages-2.png](resources/CB9EBD30B8FB1E24D41583A424E19CBC.png)

- let me try entering an invalid email again. 

![](images/261-optional-styling-error-messages-3.png)

![](images/261-optional-styling-error-messages-4.png)![261-optional-styling-error-messages-3.png](resources/6A3FC1AB705302AD7129B46856F3A553.png)![261-optional-styling-error-messages-4.png](resources/6BFAD73C6C570AB842BDC8CE46AFE304.png)

```js
<!--./views/auth/login.ejs-->

<%- include('../includes/head.ejs') %>
    <link rel="stylesheet" href="/css/forms.css">
    <link rel="stylesheet" href="/css/auth.css">
</head>

<body>
   <%- include('../includes/navigation.ejs') %>

    <main>
        <% if (errorMessage) { %>
            <div class="user-message user-message--error"><%= errorMessage %></div>
        <% } %>
        <form class="login-form" action="/login" method="POST">
            <div class="form-control">
                <label for="email">E-Mail</label>
                <input type="email" name="email" id="email">
            </div>
            <div class="form-control">
                <label for="password">Password</label>
                <input type="password" name="password" id="password">
            </div>
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <button class="btn" type="submit">Login</button>
        </form>
    </main>
<%- include('../includes/end.ejs') %>
```

```js
/*./public/css/main.css*/

@import url('https://fonts.googleapis.com/css?family=Open+Sans:400,700');

* {
  box-sizing: border-box;
}

body {
  padding: 0;
  margin: 0;
  font-family: 'Open Sans', sans-serif;
}

main {
  padding: 1rem;
  margin: auto;
}

form {
  display: inline;
}

.centered {
  text-align: center;
}

.image {
  height: 20rem;
}

.image img {
  height: 100%;
}

.main-header {
  width: 100%;
  height: 3.5rem;
  background-color: #00695c;
  padding: 0 1.5rem;
  display: flex;
  align-items: center;
}

.main-header__nav {
  height: 100%;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.main-header__item-list {
  list-style: none;
  margin: 0;
  padding: 0;
  display: flex;
}

.main-header__item {
  margin: 0 1rem;
  padding: 0;
}

.main-header__item a,
.main-header__item button {
  font: inherit;
  background: transparent;
  border: none;
  text-decoration: none;
  color: white;
  cursor: pointer;
}

.main-header__item a:hover,
.main-header__item a:active,
.main-header__item a.active,
.main-header__item button:hover,
.main-header__item button:active {
  color: #ffeb3b;
}

.mobile-nav {
  width: 30rem;
  height: 100vh;
  max-width: 90%;
  position: fixed;
  left: 0;
  top: 0;
  background: white;
  z-index: 10;
  padding: 2rem 1rem 1rem 2rem;
  transform: translateX(-100%);
  transition: transform 0.3s ease-out;
}

.mobile-nav.open {
  transform: translateX(0);
}

.mobile-nav__item-list {
  list-style: none;
  display: flex;
  flex-direction: column;
  margin: 0;
  padding: 0;
}

.mobile-nav__item {
  margin: 1rem;
  padding: 0;
}

.mobile-nav__item a {
  text-decoration: none;
  color: black;
  font-size: 1.5rem;
  padding: 0.5rem 2rem;
}

.mobile-nav__item a:active,
.mobile-nav__item a:hover,
.mobile-nav__item a.active {
  background: #00695c;
  color: white;
  border-radius: 3px;
}

#side-menu-toggle {
  border: 1px solid white;
  font: inherit;
  padding: 0.5rem;
  display: block;
  background: transparent;
  color: white;
  cursor: pointer;
}

#side-menu-toggle:focus {
  outline: none;
}

#side-menu-toggle:active,
#side-menu-toggle:hover {
  color: #ffeb3b;
  border-color: #ffeb3b;
}

.backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100vh;
  background: rgba(0, 0, 0, 0.5);
  z-index: 5;
  display: none;
}

.grid {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-around;
  align-items: stretch;
}

.card {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.26);
}

.card__header,
.card__content {
  padding: 1rem;
}

.card__header h1,
.card__content h1,
.card__content h2,
.card__content p {
  margin: 0;
}

.card__image {
  width: 100%;
}

.card__image img {
  width: 100%;
}

.card__actions {
  padding: 1rem;
  text-align: center;
}

.card__actions button,
.card__actions a {
  margin: 0 0.25rem;
}

.btn {
  display: inline-block;
  padding: 0.25rem 1rem;
  text-decoration: none;
  font: inherit;
  border: 1px solid #00695c;
  color: #00695c;
  background: white;
  border-radius: 3px;
  cursor: pointer;
}

.btn:hover,
.btn:active {
  background-color: #00695c;
  color: white;
}

.btn.danger {
  color: red;
  border-color: red;
}

.btn.danger:hover,
.btn.danger:active {
  background: red;
  color: white;
}

.user-message {
  margin: auto;
  width: 90%;
  border: 1px solid #4771fa;
  padding: 0.5rem;
  border-radius: 3px;
  background: #8ea8fd;
  text-align: center;
}

.user-message--error {
  border-color: red;
  background: rgb(255, 176, 176);
  color: red;
}

@media (min-width: 768px) {
  .main-header__nav {
    display: flex;
  }

  #side-menu-toggle {
    display: none;
  }

  .user-message {
    width: 30rem;
  }
}
```

\* Chapter 262: Finishing The Flash Messages
============================================

1\. update

- ./controllers/auth.js

![](images/262-finishing-the-flash-messages-1.png)![262-finishing-the-flash-messages-1.png](resources/0F9ACD60376A8742A74D0B808B746BD9.png)

- if i console log ‘req.flash(‘error’)’, i see it’s an empty array. 

![](images/262-finishing-the-flash-messages-2.png)

![](images/262-finishing-the-flash-messages-3.png)![262-finishing-the-flash-messages-2.png](resources/92A31B94F91CF39638AF07229F4C5A7C.png)![262-finishing-the-flash-messages-3.png](resources/0D2A5AE29F3BF2D7EF0726B58F36CE9C.png)

————————————————————————

![](images/262-finishing-the-flash-messages-4.png)

![](images/262-finishing-the-flash-messages-5.png)![262-finishing-the-flash-messages-4.png](resources/E58D281499CE754D861D5AA369F16F00.png)![262-finishing-the-flash-messages-5.png](resources/5F1BAA2A5AA01F394E36E25568056051.png)

```js
//./controllers/auth.js

const bcrypt = require('bcryptjs');

const User = require('../models/user');

exports.getLogin = (req, res, next) => {
  let message = req.flash('error')
  if(message.length > 0){
    message = message[0]
  } else {
    message = null
  }
  res.render('auth/login', {
    path: '/login',
    pageTitle: 'Login',
    errorMessage: req.flash('error')
  });
};

exports.getSignup = (req, res, next) => {
  res.render('auth/signup', {
    path: '/signup',
    pageTitle: 'Signup',
    errorMessage: message
  });
};

exports.postLogin = (req, res, next) => {
  const email = req.body.email;
  const password = req.body.password;
  User.findOne({ email: email })
    .then(user => {
      if (!user) {
        req.flash('error', 'Invalid email or password.')
        return res.redirect('/login');
      }
      bcrypt
        .compare(password, user.password)
        .then(doMatch => {
          if (doMatch) {
            req.session.isLoggedIn = true;
            req.session.user = user;
            return req.session.save(err => {
              console.log(err);
              res.redirect('/');
            });
          }
          res.redirect('/login');
        })
        .catch(err => {
          console.log(err);
          res.redirect('/login');
        });
    })
    .catch(err => console.log(err));
};

exports.postSignup = (req, res, next) => {
  const email = req.body.email;
  const password = req.body.password;
  const confirmPassword = req.body.confirmPassword;
  User.findOne({ email: email })
    .then(userDoc => {
      if (userDoc) {
        return res.redirect('/signup');
      }
      return bcrypt
        .hash(password, 12)
        .then(hashedPassword => {
          const user = new User({
            email: email,
            password: hashedPassword,
            cart: { items: [] }
          });
          return user.save();
        })
        .then(result => {
          res.redirect('/login');
        });
    })
    .catch(err => {
      console.log(err);
    });
};

exports.postLogout = (req, res, next) => {
  req.session.destroy(err => {
    console.log(err);
    res.redirect('/');
  });
};
```

\* Chapter 263: Adding Additional Flash Messages
================================================

1\. update

- ./controllers/auth.js

- ./views/auth/signup.ejs

![](images/263-adding-additional-flash-messages-1.png)

![](images/263-adding-additional-flash-messages-2.png)![263-adding-additional-flash-messages-1.png](resources/677C54AEABE73475A86B5CCD42612AA8.png)![263-adding-additional-flash-messages-2.png](resources/F5C8FAC41134D635737A353EFB15CA56.png)

- i might have a valid email but an invalid password and i get this error message

![](images/263-adding-additional-flash-messages-3.png)

![](images/263-adding-additional-flash-messages-4.png)![263-adding-additional-flash-messages-3.png](resources/292ACB46D5EB342F5BFC7D3D883C5A0F.png)![263-adding-additional-flash-messages-4.png](resources/BD435354C92D02E698050126BB5AFA70.png)

- and with valid credentials, it works fine though. 

![](images/263-adding-additional-flash-messages-5.png)

![](images/263-adding-additional-flash-messages-6.png)![263-adding-additional-flash-messages-5.png](resources/DDDF731E3BCF0464522D182DE657715A.png)![263-adding-additional-flash-messages-6.png](resources/ABB992B9AAD209CED7481F651F1B9C4A.png)

—————————————————————

![](images/263-adding-additional-flash-messages-6.png)

![](images/263-adding-additional-flash-messages-7.png)

![](images/263-adding-additional-flash-messages-8.png)![263-adding-additional-flash-messages-7.png](resources/05FC10068AE2B46F99C75F9D3EF60BDF.png)![263-adding-additional-flash-messages-8.png](resources/33695785FBE9ABD10A0D2C897C34CF15.png)

- if i enter the E-mail address which does already exist, i’m redirected without having any effect. 

———————————————————————

![](images/263-adding-additional-flash-messages-9.png)

![](images/263-adding-additional-flash-messages-10.png)

![](images/263-adding-additional-flash-messages-11.png)

![](images/263-adding-additional-flash-messages-12.png)![263-adding-additional-flash-messages-9.png](resources/E1F6CB7C787BCFDB8BE7CDB3C194B11B.png)![263-adding-additional-flash-messages-10.png](resources/70004C765AAD3839760E3D52ACB4C05E.png)![263-adding-additional-flash-messages-11.png](resources/D123D4B30CD9CC1E667EC26544E92BA0.png)![263-adding-additional-flash-messages-12.png](resources/10C0565838C5381717B7A119667EA5F8.png)

- if i create a valid user with a valid email, this works. 

![](images/263-adding-additional-flash-messages-13.png)![263-adding-additional-flash-messages-13.png](resources/EBC15DBE628332AD4BCFB290436E8FE9.png)

- we can see that was added.

```js
//./controllers/auth.js

const bcrypt = require('bcryptjs');

const User = require('../models/user');

exports.getLogin = (req, res, next) => {
  let message = req.flash('error')
  if(message.length > 0){
    message = message[0]
  } else {
    message = null
  }
  res.render('auth/login', {
    path: '/login',
    pageTitle: 'Login',
    errorMessage: message
  });
};

exports.getSignup = (req, res, next) => {
  let message = req.flash('error')
  if(message.length > 0){
    message = message[0]
  } else {
    message = null
  }
  res.render('auth/signup', {
    path: '/signup',
    pageTitle: 'Signup',
    errorMessage: message
  });
};

exports.postLogin = (req, res, next) => {
  const email = req.body.email;
  const password = req.body.password;
  User.findOne({ email: email })
    .then(user => {
      if (!user) {
        req.flash('error', 'Invalid email or password.')
        return res.redirect('/login');
      }
      bcrypt
        .compare(password, user.password)
        .then(doMatch => {
          if (doMatch) {
            req.session.isLoggedIn = true;
            req.session.user = user;
            return req.session.save(err => {
              console.log(err);
              res.redirect('/');
            });
          }
          /**if we have a password that doesn't match,
           * here is where we also redirect to login,
           * i also want to flash my invalid email or password message onto the session
           * this is another great place
           */
          req.flash('error', 'Invalid email or password.')
          res.redirect('/login');
        })
        .catch(err => {
          console.log(err);
          res.redirect('/login');
        });
    })
    .catch(err => console.log(err));
};

exports.postSignup = (req, res, next) => {
  const email = req.body.email;
  const password = req.body.password;
  const confirmPassword = req.body.confirmPassword;
  User.findOne({ email: email })
    .then(userDoc => {
      if (userDoc) {
        req.flash('error', 'E-Mail exists already, please pick a different one. ')
        return res.redirect('/signup');
      }
      return bcrypt
        .hash(password, 12)
        .then(hashedPassword => {
          const user = new User({
            email: email,
            password: hashedPassword,
            cart: { items: [] }
          });
          return user.save();
        })
        .then(result => {
          res.redirect('/login');
        });
    })
    .catch(err => {
      console.log(err);
    });
};

exports.postLogout = (req, res, next) => {
  req.session.destroy(err => {
    console.log(err);
    res.redirect('/');
  });
};
```

```js
<!--./views/auth/signup.ejs-->

<%- include('../includes/head.ejs') %>
    <link rel="stylesheet" href="/css/forms.css">
    <link rel="stylesheet" href="/css/auth.css">
</head>

<body>
   <%- include('../includes/navigation.ejs') %>

    <main>
        <% if (errorMessage) { %>
            <div class="user-message user-message--error"><%= errorMessage %></div>
        <% } %>
        <form class="login-form" action="/signup" method="POST">
            <div class="form-control">
                <label for="email">E-Mail</label>
                <input type="email" name="email" id="email">
            </div>
            <div class="form-control">
                <label for="password">Password</label>
                <input type="password" name="password" id="password">
            </div>
            <div class="form-control">
                <label for="confirmPassword">Confirm Password</label>
                <input type="password" name="confirmPassword" id="confirmPassword">
            </div>
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <button class="btn" type="submit">Signup</button>
        </form>
    </main>
<%- include('../includes/end.ejs') %>
```

\* Chapter 264: Wrap Up
=======================

![](images/264-wrap-up-1.png)![264-wrap-up-1.png](resources/9A4EB35790F927C52893B5ACB52760AB.png)