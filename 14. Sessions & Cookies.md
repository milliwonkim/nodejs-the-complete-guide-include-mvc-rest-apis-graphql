\* Chapter 226: Module Introduction
===================================

![](images/226-module-introduction-1.png)

\* Chapter 227: What is a Cookie?
=================================

![](images/227-what-is-a-cookie-1.png)

- the request requires us to store some kind of data in the browser. 

- let’s say we have a login page and when the user logs in, we wanna store the information that the user is logged in somewhere, so that when the user reloads the page and therefore technically a new request is sent, we still have that information around that the user is logged in

- cookie is important to teliing the user or to storing that information that the user is authenticated. we can store that information in the browser in the environment the user interacts with and we can send this with subsequent requests to include the cookie there to send the data we stored in the cookie like the information that we are logged in to the server. so cookies are stored on the client side.

\* Chapter 228: The Current Project Status
==========================================

1\. update

- ./views/includes/navigation.ejs

- ./public/css/main.css

- authentication is a great example for data you would wanna store for a specific user and that is one of the typical use cases for using cookies and sessions.

```js
<!--./views/includes/navigation.ejs-->

<div class="backdrop"></div>
<header class="main-header">
    <button id="side-menu-toggle">Menu</button>
    <nav class="main-header__nav">
        <ul class="main-header__item-list">
            <li class="main-header__item">
                <a class="<%= path === '/' ? 'active' : '' %>" href="/">Shop</a>
            </li>
            <li class="main-header__item">
                <a class="<%= path === '/products' ? 'active' : '' %>" href="/products">Products</a>
            </li>
            <li class="main-header__item">
                <a class="<%= path === '/cart' ? 'active' : '' %>" href="/cart">Cart</a>
            </li>
            <li class="main-header__item">
                <a class="<%= path === '/orders' ? 'active' : '' %>" href="/orders">Orders</a>
            </li>
            <!-- <li class="main-header__item">
                <a class="<%= path === '/admin/add-product' ? 'active' : '' %>" href="/admin/add-product">Add Product
                </a>
            </li>
            <li class="main-header__item">
                <a class="<%= path === '/admin/products' ? 'active' : '' %>" href="/admin/products">Admin Products
                </a>
            </li> -->
        </ul>
        <!--i added new list item which is named 'login'-->
        <ul class="main-header__item-list">
            <li class="main-header__item">
                <a href="/login">Login</a>
            </li>
        </ul>
    </nav>
</header>

<nav class="mobile-nav">
    <ul class="mobile-nav__item-list">
        <li class="mobile-nav__item">
            <a class="<%= path === '/' ? 'active' : '' %>" href="/">Shop</a>
        </li>
        <li class="mobile-nav__item">
            <a class="<%= path === '/products' ? 'active' : '' %>" href="/products">Products</a>
        </li>
        <li class="mobile-nav__item">
            <a class="<%= path === '/cart' ? 'active' : '' %>" href="/cart">Cart</a>
        </li>
        <li class="mobile-nav__item">
            <a class="<%= path === '/orders' ? 'active' : '' %>" href="/orders">Orders</a>
        </li>
        <li class="mobile-nav__item">
            <a class="<%= path === '/admin/add-product' ? 'active' : '' %>" href="/admin/add-product">Add Product
            </a>
        </li>
        <li class="mobile-nav__item">
            <a class="<%= path === '/admin/products' ? 'active' : '' %>" href="/admin/products">Admin Products
            </a>
        </li>
    </ul>
</nav>
```

```js
/*./public/css/main.css*/

@import url('https://fonts.googleapis.com/css?family=Open+Sans:400,700');

* {
  box-sizing: border-box;
}

body {
  padding: 0;
  margin: 0;
  font-family: 'Open Sans', sans-serif;
}

main {
  padding: 1rem;
  margin: auto;
}

form {
  display: inline;
}

.centered {
  text-align: center;
}

.image {
  height: 20rem;
}

.image img {
  height: 100%;
}

.main-header {
  width: 100%;
  height: 3.5rem;
  background-color: #00695c;
  padding: 0 1.5rem;
  display: flex;
  align-items: center;
}

.main-header__nav {
  height: 100%;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.main-header__item-list {
  list-style: none;
  margin: 0;
  padding: 0;
  display: flex;
}

.main-header__item {
  margin: 0 1rem;
  padding: 0;
}

.main-header__item a,
.main-header__item button {
  font: inherit;
  background: transparent;
  border: none;
  text-decoration: none;
  color: white;
  cursor: pointer;
}

.main-header__item a:hover,
.main-header__item a:active,
.main-header__item a.active,
.main-header__item button:hover,
.main-header__item button:active {
  color: #ffeb3b;
}

.mobile-nav {
  width: 30rem;
  height: 100vh;
  max-width: 90%;
  position: fixed;
  left: 0;
  top: 0;
  background: white;
  z-index: 10;
  padding: 2rem 1rem 1rem 2rem;
  transform: translateX(-100%);
  transition: transform 0.3s ease-out;
}

.mobile-nav.open {
  transform: translateX(0);
}

.mobile-nav__item-list {
  list-style: none;
  display: flex;
  flex-direction: column;
  margin: 0;
  padding: 0;
}

.mobile-nav__item {
  margin: 1rem;
  padding: 0;
}

.mobile-nav__item a {
  text-decoration: none;
  color: black;
  font-size: 1.5rem;
  padding: 0.5rem 2rem;
}

.mobile-nav__item a:active,
.mobile-nav__item a:hover,
.mobile-nav__item a.active {
  background: #00695c;
  color: white;
  border-radius: 3px;
}

#side-menu-toggle {
  border: 1px solid white;
  font: inherit;
  padding: 0.5rem;
  display: block;
  background: transparent;
  color: white;
  cursor: pointer;
}

#side-menu-toggle:focus {
  outline: none;
}

#side-menu-toggle:active,
#side-menu-toggle:hover {
  color: #ffeb3b;
  border-color: #ffeb3b;
}

.backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100vh;
  background: rgba(0, 0, 0, 0.5);
  z-index: 5;
  display: none;
}

.grid {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-around;
  align-items: stretch;
}

.card {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.26);
}

.card__header,
.card__content {
  padding: 1rem;
}

.card__header h1,
.card__content h1,
.card__content h2,
.card__content p {
  margin: 0;
}

.card__image {
  width: 100%;
}

.card__image img {
  width: 100%;
}

.card__actions {
  padding: 1rem;
  text-align: center;
}

.card__actions button,
.card__actions a {
  margin: 0 0.25rem;
}

.btn {
  display: inline-block;
  padding: 0.25rem 1rem;
  text-decoration: none;
  font: inherit;
  border: 1px solid #00695c;
  color: #00695c;
  background: white;
  border-radius: 3px;
  cursor: pointer;
}

.btn:hover,
.btn:active {
  background-color: #00695c;
  color: white;
}

.btn.danger {
  color: red;
  border-color: red;
}

.btn.danger:hover,
.btn.danger:active {
  background: red;
  color: white;
}

@media (min-width: 768px) {
  .main-header__nav {
    display: flex;
  }

  #side-menu-toggle {
    display: none;
  }
}

```

\* Chapter 229: Optional: Creating The Login Form
=================================================

1\. update

- ./routes/auth.js

- app.js

- ./controllers/auth.js

- ./views/includes/navigation.ejs

- ./views/auth/login.ejs

- ./public/css/auth.css

![](images/229-optional-creating-the-login-form-1.png)

![](images/229-optional-creating-the-login-form-2.png)

```js
// ./routes/auth.js

const express = require('express')

const authController = require('../controllers/auth')

const router = express.Router()

router.get('/login', authController.getLogin)

module.exports = router
```

```js
//app.js

const path = require('path');

const express = require('express');
const bodyParser = require('body-parser');
const mongoose = require('mongoose')

const errorController = require('./controllers/error');
const User = require('./models/user')

const app = express();

app.set('view engine', 'ejs');
app.set('views', 'views');

const adminRoutes = require('./routes/admin');
const shopRoutes = require('./routes/shop');
const authRoutes = require('./routes/auth');

app.use(bodyParser.urlencoded({ extended: false }));
app.use(express.static(path.join(__dirname, 'public')));


app.use((req, res, next) => {
  User.findById('5cbb2b2c80bd7193adb9eeeb')
    .then(user => {
      req.user = user
      next();
    })
    .catch(err => console.log(err));
});

app.use('/admin', adminRoutes);
app.use(shopRoutes);
app.use(authRoutes)

app.use(errorController.get404);

mongoose
  .connect('mongodb+srv://maximilian:DD5EbADjazBuTqk@cluster0-z3vlk.mongodb.net/shop?retryWrites=true')
  .then(result => {
    User
      .findOne()
      .then(user => {
        if(!user){
          const user = new User({
            name: 'Max',
            email: 'max@test.com',
            cart: {
              items: []
            }
          })
          user.save()
        }
      })
    app.listen(3000)
  })
  .catch(err => {
    console.log(err)
  })
```

```js
//./controllers/auth.js

exports.getLogin = (req, res, next) => {
    res.render('auth/login', {
      path: '/login',
      pageTitle: 'Login',
    });
};
```

```js
<!--./views/includes/navigation.ejs-->

<div class="backdrop"></div>
<header class="main-header">
    <button id="side-menu-toggle">Menu</button>
    <nav class="main-header__nav">
        <ul class="main-header__item-list">
            <li class="main-header__item">
                <a class="<%= path === '/' ? 'active' : '' %>" href="/">Shop</a>
            </li>
            <li class="main-header__item">
                <a class="<%= path === '/products' ? 'active' : '' %>" href="/products">Products</a>
            </li>
            <li class="main-header__item">
                <a class="<%= path === '/cart' ? 'active' : '' %>" href="/cart">Cart</a>
            </li>
            <li class="main-header__item">
                <a class="<%= path === '/orders' ? 'active' : '' %>" href="/orders">Orders</a>
            </li>
            <!-- <li class="main-header__item">
                <a class="<%= path === '/admin/add-product' ? 'active' : '' %>" href="/admin/add-product">Add Product
                </a>
            </li>
            <li class="main-header__item">
                <a class="<%= path === '/admin/products' ? 'active' : '' %>" href="/admin/products">Admin Products
                </a>
            </li> -->
        </ul>
        <!--i added new list item which is named 'login'-->
        <ul class="main-header__item-list">
            <li class="main-header__item">
                <a class="<%= path === '/login' ? 'active' : '' %>" href="/login">Login</a>
            </li>
        </ul>
    </nav>
</header>

<nav class="mobile-nav">
    <ul class="mobile-nav__item-list">
        <li class="mobile-nav__item">
            <a class="<%= path === '/' ? 'active' : '' %>" href="/">Shop</a>
        </li>
        <li class="mobile-nav__item">
            <a class="<%= path === '/products' ? 'active' : '' %>" href="/products">Products</a>
        </li>
        <li class="mobile-nav__item">
            <a class="<%= path === '/cart' ? 'active' : '' %>" href="/cart">Cart</a>
        </li>
        <li class="mobile-nav__item">
            <a class="<%= path === '/orders' ? 'active' : '' %>" href="/orders">Orders</a>
        </li>
        <li class="mobile-nav__item">
            <a class="<%= path === '/admin/add-product' ? 'active' : '' %>" href="/admin/add-product">Add Product
            </a>
        </li>
        <li class="mobile-nav__item">
            <a class="<%= path === '/admin/products' ? 'active' : '' %>" href="/admin/products">Admin Products
            </a>
        </li>
    </ul>
</nav>
```

```js
<!--./views/auth/login.ejs-->

<%- include('../includes/head.ejs') %>
    <link rel="stylesheet" href="/css/forms.css">
    <link rel="stylesheet" href="/css/auth.css">
</head>

<body>
   <%- include('../includes/navigation.ejs') %>

    <main>
        <form class="login-form" action="/login" method="POST">
            <div class="form-control">
                <label for="email">E-Mail</label>
                <input type="email" name="email" id="email">
            </div>
            <div class="form-control">
                <label for="password">Password</label>
                <!--'input type' is also 'password' so that the character are hidden-->
                <input type="password" name="password" id="password">
            </div>
            <button class="btn" type="submit">Login</button>
        </form>
    </main>
<%- include('../includes/end.ejs') %>
```

```js
/*./public/css/auth.css*/

.login-form {
    width: 20rem;
    max-width: 90%;
    margin: auto;
    display: block;
}
```

\* Chatper 230: Adding The Request Driven Login Solution
========================================================

1\. update

- ./controllers/auth.js

- routes/auth.js

- ./views/includes/navigation.ejs

- ./controllers/admin.js

- ./controllers/error.js

- ./controllers/shop.js

![](images/230-adding-the-request-driven-login-solution-1.png)

![](images/230-adding-the-request-driven-login-solution-2.png)

```js
//./controllers/auth.js

exports.getLogin = (req, res, next) => {
    res.render('auth/login', {
      path: '/login',
      pageTitle: 'Login',
      isAuthenticated: req.isLoggedIn
    });
};

exports.postLogin = (req, res, next) => {
  /**we wanna store that information that the user is authenticated
   * how could we store that?
   * i store that information in my request object and 'isLoggedIn'
   * because we are already doing a similar thing in app.js file like 'req.user = user'
   * so that we can use it for the rest of that request.
   * so in all the routes and controllers where we handle that request.
   * 
   * we can set this 'true' by default at the start it will not be set.
   * so that the value will be undefined which is treated as false
   * and that is the information i need
   * i will set to true when we do login.
   */

   /**even though i'm storing the information that i'm logged in,
    * in 'isLoggedIn', when we click the 'LogIn' button,
    * i'm storing it in my request and then i use that information in the request on every other route i handle
    * and i pass it into 'isAuthenticated' which is the field which i'm using in my frontend like ./views/includes/navigation.ejs
    * there i'm checking for 'isAuthenticated'
    * and that is what i'm passing to that frontend in my render calls
    * 
    * the problem is that i update 'isLoggedIn' here in the request
    * and what happens to the request once i send a response,
    * and we do send a response by redirecting?
    * the request is dead, it's done.
    * with a response, we basically finished a request, we got a 'request("req.isLoggedIn = true")' and we sent a 'response("res.redirect('/')")' here
    * we are done. so 'req.isLoggedIn' doesn't stick around
    * 'req.isLoggedIn' is lost after the request of after we send the response
    * 
    * so whenever we visit a different page, like where we get redirected,
    * so we get redirected here, and we reach our 'getIndex' in ./controllers/shop.js
    * and there we do render the 'shop/index' page
    * 
    * but this is a brand new request,
    * the redirection creates a brand new request and this is important to understand
    * we are working with totally separate requests and that is important
    * 
    * because your application, your page will have hundreds of users 
    * and the requests of all these users are not related to each other.
    * otherwise they could maybe look into data that they shouldn't see
    * and even the requests of a single user.
    * so requests made from the same IP address are treated as totally independent requests
    * they are not seen in a bigger context or anything like that
    * this is a good thing and deliberately designed that way 
    * and therefore any data we store here can be used as long as we are working on the same request.
    * that is why when we retrieve the user in app.js file here
    * and i store it in the 'request("req.user = user")', 
    * that is why we still can use that req.user in all our action controllers
    * because they can again, at a later point of time, 
    * this middleware in app.js file like below runs on every incoming request before our routes handle it.
    * 
    *   app.use((req, res, next) => {
    *     User.findById('5cbb2b2c80bd7193adb9eeeb')
    *         .then(user => {
    *         req.user = user
    *         next()
    *      })
    *      .catch(err => console.log(err))
    *   })
    * 
    * so the data we store on the middleware above is used in the same request cycle,
    * in our route handler in our controllers.
    * 
    * but if i change the request at the end of its lifetime 
    * like here 'req', 'res' and dead it's done, before i send the response
    * this data will be not useful to us
    * 
    */
  req.isLoggedIn = true
  res.redirect('/')
};
```

```js
// ./routes/auth.js

const express = require('express')

const authController = require('../controllers/auth')

const router = express.Router()

router.get('/login', authController.getLogin)

router.post('/login', authController.postLogin)

module.exports = router
```

```js
<!--./views/includes/navigation.ejs-->

<!--./views/includes/navigation.ejs-->

<div class="backdrop"></div>
<header class="main-header">
    <button id="side-menu-toggle">Menu</button>
    <nav class="main-header__nav">
        <ul class="main-header__item-list">
            <li class="main-header__item">
                <a class="<%= path === '/' ? 'active' : '' %>" href="/">Shop</a>
            </li>
            <li class="main-header__item">
                <a class="<%= path === '/products' ? 'active' : '' %>" href="/products">Products</a>
            </li>
            <li class="main-header__item">
                <a class="<%= path === '/cart' ? 'active' : '' %>" href="/cart">Cart</a>
            </li>
            <li class="main-header__item">
                <a class="<%= path === '/orders' ? 'active' : '' %>" href="/orders">Orders</a>
            </li>
            <% if (isAuthenticated) { %>
            <li class="main-header__item">
                <a class="<%= path === '/admin/add-product' ? 'active' : '' %>" href="/admin/add-product">Add Product
                </a>
            </li>
            <li class="main-header__item">
                <a class="<%= path === '/admin/products' ? 'active' : '' %>" href="/admin/products">Admin Products
                </a>
            </li>
            <% } %>
        </ul>
        <ul class="main-header__item-list">
            <li class="main-header__item">
                <a class="<%= path === '/login' ? 'active' : '' %>" href="/login">Login</a>
            </li>
        </ul>
    </nav>
</header>

<nav class="mobile-nav">
    <ul class="mobile-nav__item-list">
        <li class="mobile-nav__item">
            <a class="<%= path === '/' ? 'active' : '' %>" href="/">Shop</a>
        </li>
        <li class="mobile-nav__item">
            <a class="<%= path === '/products' ? 'active' : '' %>" href="/products">Products</a>
        </li>
        <li class="mobile-nav__item">
            <a class="<%= path === '/cart' ? 'active' : '' %>" href="/cart">Cart</a>
        </li>
        <li class="mobile-nav__item">
            <a class="<%= path === '/orders' ? 'active' : '' %>" href="/orders">Orders</a>
        </li>
        <li class="mobile-nav__item">
            <a class="<%= path === '/admin/add-product' ? 'active' : '' %>" href="/admin/add-product">Add Product
            </a>
        </li>
        <li class="mobile-nav__item">
            <a class="<%= path === '/admin/products' ? 'active' : '' %>" href="/admin/products">Admin Products
            </a>
        </li>
    </ul>
</nav>
```

```js
exports.get404 = (req, res, next) => {
  res.status(404)
     .render(
       '404',
       {
         pageTitle: 'Page Not Found',
         path: '/404',
         isAuthenticated: req.isLoggedIn
       }
    );
};
```

```js
//./controllers/shop.js

const Product = require('../models/product');
const Order = require('../models/order')

exports.getProducts = (req, res, next) => {
  Product.find()
    .then(products => {
      console.log(products)
      res.render('shop/product-list', {
        prods: products,
        pageTitle: 'All Products',
        path: '/products',
        isAuthenticated: req.isLoggedIn
      });
    })
    .catch(err => {
      console.log(err);
    });
};

exports.getProduct = (req, res, next) => {
  const prodId = req.params.productId;
  Product.findById(prodId)
    .then(product => {
      res.render('shop/product-detail', {
        product: product,
        pageTitle: product.title,
        path: '/products',
        isAuthenticated: req.isLoggedIn
      });
    })
    .catch(err => console.log(err));
};

exports.getIndex = (req, res, next) => {
  Product.find()
    .then(products => {
      res.render('shop/index', {
        prods: products,
        pageTitle: 'Shop',
        path: '/',
        isAuthenticated: req.isLoggedIn
      });
    })
    .catch(err => {
      console.log(err);
    });
};

exports.getCart = (req, res, next) => {
  req.user
    .populate('cart.items.productId')
    .execPopulate()
    .then(user => {
      const products = user.cart.items
      res.render('shop/cart', {
        path: '/cart',
        pageTitle: 'Your Cart',
        products: products,
        isAuthenticated: req.isLoggedIn
      });
    })
    .catch(err => console.log(err));
};

exports.postCart = (req, res, next) => {
  const prodId = req.body.productId;
  Product.findById(prodId)
    .then(product => {
      return req.user.addToCart(product);
    })
    .then(result => {
      console.log(result);
      res.redirect('/cart');
    });
};

exports.postCartDeleteProduct = (req, res, next) => {
  const prodId = req.body.productId;
  req.user
    .removeFromCart(prodId)
    .then(result => {
      res.redirect('/cart');
    })
    .catch(err => console.log(err));
};

exports.postOrder = (req, res, next) => {
  req.user
  .populate('cart.items.productId')
  .execPopulate()
  .then(user => {
    console.log(user.cart.items)
    const products = user.cart.items.map(i => {

      return { quantity: i.quantity, product: { ...i.productId._doc } }
    })
    const order = new Order({
      user: {
        name: req.user.name,
        userId: req.user
      },
      products: products
    })
    order.save()
  })
  .then(result => {
      return req.user.clearCart()
  })
  .then(() => {
    res.redirect('/orders');
  })
  .catch(err => console.log(err));
};

exports.getOrders = (req, res, next) => {
  Order
    .find({ 'user.userId': req.user._id })
    .then(orders => {
      res.render('shop/orders', {
        path: '/orders',
        pageTitle: 'Your Orders',
        orders: orders,
        isAuthenticated: req.isLoggedIn
      });
    })
    .catch(err => console.log(err));
};

```

\* Chapter 231: Setting A Cookie
================================

1\. update

- ./controllers/auth.js

![](images/231-setting-a-cookie-1.png)

![](images/231-setting-a-cookie-2.png)

- open your developer tools and go to ‘Application’ tab and there to cookies, there is the ‘Cookies’ and if you expand this, you should see your current address here and if you click on that, you will see some cookies 

- some cookies will be set by 3rd party plugins. and you will also see ‘loggedIn’ and the value is true. that is the cookie we just set. 

- there is domain to which it belongs, the path, when it will expire and this state is in the past becasue it’s a so-called session cookie which will expire once you close the browser and comeback, you see the size. 

- cookies is now set. now this cookie is not only set but the browser by default sends it to the server with every request we make

![](images/231-setting-a-cookie-3.png)

- this is the request which was sent to the product page, and this is the Header and go to ‘Request Header’, you see that a cookie was sent

- the first one comes from an extension but the 2nd one is our cookie. so it was sent to our server and now since we have that, every request will have that cookie attached to itself and therefore this data is sent with every request and now we can use that.

![](images/231-setting-a-cookie-4.png)

- you see this output. we can ignore first cookie but 2nd one ‘loggedIn=true' is our ‘loggedIn’ cookie. 

![](images/231-setting-a-cookie-5.png)

![](images/231-setting-a-cookie-6.png)

![](images/231-setting-a-cookie-7.png)

```js
//./controllers/auth.js

exports.getLogin = (req, res, next) => {
  /**i can extract 'isLoggedIn' information from the incoming request header,
   * i'm getting the cookie header and i'm getting the 2nd cookie that is sent which happens to be our 'isLoggedIn' in cookie
   * and then i extract 'true' value.
   */
    const isLoggedIn = req.get('Cookie')
                          .split(';')[1]
                          .trim()
                          .split('=')[1]
    res.render('auth/login', {
      path: '/login',
      pageTitle: 'Login',
      /**and now i have 'isLoggedIn' information which i can pass to 'isAuthenticated' 
       * with that on that page, if i reload it, there are 'Admin Products' and 'Add Product' in the menu bar
       * because we enable that again
       * because we store that information across request
      */
      isAuthenticated: isLoggedIn
    });
};

exports.postLogin = (req, res, next) => {
  /** so we found out that using a request for storing this is not ideal
    * because the request is dead after sending a response.
    * which alternatives do we have?
    * 
    * one alternative would be 'global' variable
    * you could use a global variable which you store in an extra file
    * and which you export from that file and which you then change 
    * and that varible survive your request cycles
    * but since that variable would be shared across all request,
    * it would be also shared across all users
    * 
    * so that is where cookies can help us
    * with cookiees we can store data in the browser of a single user
    * and store data in that browser which is customized to that user
    * which doesn't affect all the other user
    * but can be sent with requests to tell us 
    * hey i already am authenticated and that is exactly what we will do here
    * 
    * we can set a cookie by 'setHeader()' on our response
    * in 'setHeader()', we first of all define the name of the header
    * and the name is 'Set-Cookie'
    * then you have the value for cookie in 2nd argument
    * and its simplest form is key-value pair where you define any name you want and any value you want
    * so 'loggedIn=true' would set a cookie
    * 
    */
  res.setHeader('Set-Cookie', 'loggedIn=true')
  res.redirect('/')
};

```

\* Chapter 232: Manipulating Cookies
====================================

1\. update

- ./controllers/auth.js

![](images/232-manipulating-cookies-1.png)

![](images/232-manipulating-cookies-2.png)

- in the last lecture, i showed you how you can set a cookie and some bit too complex way of extracting that cookie. if you wanna extract cookies, there also are 3rd party package which can help you with that.

- but our approach has another flaw. since i can access my cookies that easily in the developer tool, i can easily change them, i can go here and manipulate the value. 

![](images/232-manipulating-cookies-3.png)

![](images/232-manipulating-cookies-4.png)

- for example if i set it to false and i reload, i’m still logged in because false is sent as text and text is always treated as true. but we can simply add a comparison here and see if that value is equal to true, so to the text true here. 

![](images/232-manipulating-cookies-5.png)

- if i reload here, i’m not logged in anymore. 

![](images/232-manipulating-cookies-6.png)

![](images/232-manipulating-cookies-7.png)

- and if i change it back to true, and i reload, i am. 

- so the issue here is we can manipulate that from inside the browser and obviously you don’t wanna allow the user of your website to login by simply manipulating some cookie value. 

- whilst it’s interesting to store some data in the client side, especially things that are related to tracking users, advertisements tracking and so on. whilst this is interesting, sensitive data should not be stored in the browser because users can edit then as you see. we can edit our logged in cookie. so whilst cookies are generally good thing for storing data across requests, but it might not be the best approach in all scenarios and that’s exactly something where sessions can help us with. however before we dive into sessions, let me explain you some other fields you can configure about a cookie which will also highlight when a cookie does make sense to be used. before we then dive into the scenario where it’s not the best tool.

```js
//./controllers/auth.js

exports.getLogin = (req, res, next) => {
  /**if that value is equal to true,
   * so to the text true here.
   */
    const isLoggedIn = req.get('Cookie')
                          .split(';')[1]
                          .trim()
                          .split('=')[1] === 'true'
    res.render('auth/login', {
      path: '/login',
      pageTitle: 'Login',
      isAuthenticated: isLoggedIn
    });
};

exports.postLogin = (req, res, next) => {
  res.setHeader('Set-Cookie', 'loggedIn=true')
  res.redirect('/')
};
```

\* Chapter 233: Configuring Cookies
===================================

1\. update

- ./controllers/auth.js

![](images/233-configuring-cookies-1.png)

- so we manipulate cookies. so storing sensitive data is not ideal but for example for tracking users, it’s a popular instrument and why is that? because as you can see with the cookies i have here, the cookies don’t only have to relate to your page. a cookie can also be sent to another page and that is a common instrument in tracking where you have that so-called ’tracking pixel on pages’ which is an imageUrl with no real image.

- but that image can be located on, for example, google’s server and you have a cookie on that page which is also sent along with that and therefore google can track on which page you are and how you are moving through the web even if you are not on their website because some data is stored in your client and you could delete it which is why you can block such mechanisms too. 

- but it’s stored there and it’s sent with every request to google. so they can track you without you being on that server, so storing that information on their servers would not work but storing it on your computer will work because that can be sent on every page you visit. so that is something where this could be interesting if you wanna track your users, that is common things to do.

![](images/233-configuring-cookies-2.png)

![](images/233-configuring-cookies-3.png)

- we could set ‘Max-Age=10’ for example. now if i click that login button here, i got ‘loggedIn’ and you see the expire date also changed, the expiry date. the expiry date is today and now it already is expired 

![](images/233-configuring-cookies-4.png)

and if i reload that page, ‘loggedIn’ is gone. so this is something we can do.

![](images/233-configuring-cookies-5.png)

![](images/233-configuring-cookies-6.png)

![](images/233-configuring-cookies-7.png)

- let’s comment this out and set ‘isAuthenticated' always to false temporily because of showing you how this cookie is now set.

- if i reload and i click here, you don’t see the cookie here because i added ’Secure’ and it would only be set if we are serving the page via https. 

![](images/233-configuring-cookies-8.png)

![](images/233-configuring-cookies-9.png)

![](images/233-configuring-cookies-10.png)

- and you can also set this to ‘httpOnly’ and if i reload and login, it’s set but now it has this checkmark in the http column. and that means that now we can’t access the cookie value through client side javascript. so in the scripts running in the browser, this can be an important security mechanism because it protects us against cross-site scripting attacks now. because your client side javascript where someone could have injected malicious code can’t read your cookie values and that will be important later with authentication where a cookie will not store the sensitive information but an important part of authenticating the user. so this can be an extra security layer because the cookie will still be attached to every request that is sent to the server, but you can’t read the cookie value from inside the browser javascript code. 

![](images/233-configuring-cookies-11.png)

- as a user in the development tools, you can still read it, but it’s your own cookie and you will not store information like hey i’m logged in there because that would be easy to manipulate and you can’t protect against that. 

- often you will not directly set your cookies because you rather use some package like, for example, for authentication that will manage setting the cookie for you.

```js
//./controllers/auth.js

exports.getLogin = (req, res, next) => {
    const isLoggedIn = req.get('Cookie')
                          .split(';')[1]
                          .trim()
                          .split('=')[1] === 'true'
    res.render('auth/login', {
      path: '/login',
      pageTitle: 'Login',
      isAuthenticated: isLoggedIn
    });
};

exports.postLogin = (req, res, next) => {
  /**you can also configure cookies.
   * we set a value but you can set more things than just the value.
   * here i set my cookie by adding the key-value pair ‘loggedIn=true'. we could add multiple cookies,
   *
   * we can also add a semi-colon ; after the key-value pair
   * and for example set expire to some expiration date,
   * this date would have to follow a certain format,
   * the http date format.
   * you could set a certain data when this cookie will 'Expire'
   * because remember if you don't set this,
   * it will expire once you close your browser,
   *
   * alternatively to 'Expires'
   * you can set 'Max-Age' which is a number in seconds,
   * how long that cookie should stay around
   * we could set this to '10' for example
   *
   * and if you wanna control, for example, how long you wanna track a user
   * or we will use that together with authentication later,
   * you could use this to control how long an authenticated session stays active for a user.
   * you might know that from your online back where you timeout after a certain duration
   *
   * you can add a domain to which the cookie should be sent. 
   * and we again are on that tracking thing again.
   * 
   * you can add 'Secure' without an equal sign, just 'Secure'
   * this means this cookie will only be set if the page is served via https
   * i can't demonstrate this because our local development server is not using https
   * but we will eventually https later in the course. 
   * 
   * */
  res.setHeader('Set-Cookie', 'loggedIn=true; HttpOnly')
  res.redirect('/')
};

```

\* Chapter 234: What Is A Session?
==================================

![](images/234-what-is-a-session-1.png)

- instead of storing the information that the user is authenticated in the frontend which was a bad place, we will store it in the backend with a so-called ’session’ 

- we only wanna share the information across all requests of the same user and that’s really important. the same user so that other users can’t see your data. for that we need to store it on the server. we will start by storing it in memory which is then similar to storing in that variable. but eventually we will move to a different session storage. the database 

- and we need one important piece of information. a client needs to tell the server to which session he belongs because the session will in the end be an entry stored in memory or stored in a database. 

- we are not matching this by IP address. because that is a bit hard to maintain and can be faked. instead we will use a cookie where we will store the ID of the session. now you can still change that and assume a different ID if you wanna but that will not work because the value we store will not be the ID but the hashed ID, hashed with a certain algorithm where only the can confirm that it hasn’t been fiddled with so that you didn’t play around with it. 

- so this will be secure way because you store the ID in an encrypted way where only the server is able to confirm that stored cookie value relate to a certain ID in the database and therefore we got a safe value stored in the cookie which you can’t. you can change it but you will not assume a different session. 

- a session can be matched and that session can then contain the confidential data which you can’t change from inside the browser. 

\* Chapter 235: Initializing The Session Middleware
===================================================

1\. update

- app.js

![](images/235-initializing-the-session-middleware-1.png)

- ’npm install —save express-session’ is a package which is part of the express.js suite but not baked into express.js itself.

```js
//app.js

const path = require('path');

const express = require('express');
const bodyParser = require('body-parser');
const mongoose = require('mongoose')
/**we wanna initialize that session early on. 
 * when we start up our server then we wanna initialize the session middleware at least 
 * and the session will then be used for every incoming request. 
*/
const session = require('express-session')

const errorController = require('./controllers/error');
const User = require('./models/user')

const app = express();

app.set('view engine', 'ejs');
app.set('views', 'views');

const adminRoutes = require('./routes/admin');
const shopRoutes = require('./routes/shop');
const authRoutes = require('./routes/auth');

app.use(bodyParser.urlencoded({ extended: false }));
app.use(express.static(path.join(__dirname, 'public')));
/**we pass a javascript object where we configure the session setup
 * 'secret' will be used for signing the hash which secretly stores our ID in the cookie
 * in production, this should be a long string value 
 * 
 * 'resave: false' means that the session will not be saved on every request that is done.
 * so on every response that is sent, but only if something changed in the session. 
 * this will obviously improve performance and so on.
 * 
 * 'saveUninitialized' value which you should set to false
 * because this will also basically ensure that no session gets saved for a request where it doesn't need to be saved
 * because nothing was changed about it.
 * 
 * this is the core things you need to set.
 * you could, for example, also configure the session cookie,
 * you could give it a 'maxAge' by setting a date
 * or add the 'expires' key
 * 
 * anyway middleware is initialized and we are now ready to use the session.
 */
app.use(session({secret: 'my secret', resave: false, saveUninitialized: false}))

app.use((req, res, next) => {
  User.findById('5cbb2b2c80bd7193adb9eeeb')
    .then(user => {
      req.user = user
      next();
    })
    .catch(err => console.log(err));
});

app.use('/admin', adminRoutes);
app.use(shopRoutes);
app.use(authRoutes)

app.use(errorController.get404);

mongoose
  .connect('mongodb+srv://maximilian:DD5EbADjazBuTqk@cluster0-z3vlk.mongodb.net/shop?retryWrites=true')
  .then(result => {
    User
      .findOne()
      .then(user => {
        if(!user){
          const user = new User({
            name: 'Max',
            email: 'max@test.com',
            cart: {
              items: []
            }
          })
          user.save()
        }
      })
    app.listen(3000)
  })
  .catch(err => {
    console.log(err)
  })
```

\* Chapter 236: Using The Session Middleware
============================================

1\. update

- ./controllers/auth.js

![](images/236-using-the-session-middleware-1.png)

![](images/236-using-the-session-middleware-2.png)

- if i reload and get rid of ‘loggedIn’ cookie. 

![](images/236-using-the-session-middleware-3.png)

![](images/236-using-the-session-middleware-4.png)

- now if i click ‘login’ and what you should see is that a new cookie ‘connect.sid' was added for a session id cookie. 

- and you will see some strange string in ‘Value' and that is what i meant. this is encrypted value. this is now the cookie. by default this is a session cookie so it will expire when you close the browser. 

- it’s session cookie that will identify your user here, your running instance of this website where you are browsing around, this will identify you to the server and to the session. 

![](images/236-using-the-session-middleware-5.png)

![](images/236-using-the-session-middleware-6.png)

![](images/236-using-the-session-middleware-7.png)

- go to login page and go back to our server and there you see the session object is logged. 

![](images/236-using-the-session-middleware-8.png)

![](images/236-using-the-session-middleware-9.png)

![](images/236-using-the-session-middleware-10.png)

- but if i edit this and go to login page and go back to our server, you see true here because in the session ‘isLoggedIn’ is stored.

![](images/236-using-the-session-middleware-11.png)

![](images/236-using-the-session-middleware-12.png)

- and we can go to different page and com back to login and these are all individual requests which technically are totally individual from each other, totally separated 

![](images/236-using-the-session-middleware-13.png)

- and still we see true here because we still store this in the session on the server side by default, just in the memory not in the database yet.

- and session is identified for this browser because we have that cookie. and i can prove that to you by starting another browser and this will technically be treated as a totally different sessoin and environment, could be a totally different machine. 

![](images/236-using-the-session-middleware-14.png)

![](images/236-using-the-session-middleware-15.png)

- so if i click login here in different browser firefox, you see undefined and undefined is coming from the login request i sent. because this browser, this user, technically this is a totally different user even though i’m the same but it’s a different browser, different user, this user doesn’t have this cookie set for him, doesn’t have an active session on the server. 

- and this is how we can store data that persists across requests

- it still needs a cookie to identify the user but the sensitive information is stored on the server. we can’t modify it.

- what we see already is the core mechanism behind authenticating users in the web. 

- there’s another examples

```js
//./controllers/auth.js

exports.getLogin = (req, res, next) => {
/*
    const isLoggedIn = req.get('Cookie')
                          .split(';')[1]
                          .trim()
                          .split('=')[1] === 'true'
*/
    console.log(req.session.isLoggedIn)
    res.render('auth/login', {
      path: '/login',
      pageTitle: 'Login',
      isAuthenticated: false
    });
};

exports.postLogin = (req, res, next) => {
  User.findById('5cbb2b2c80bd7193adb9eeeb')
    .then(user => {
  /**instead of cookies,
   * request and 'session' object which is added by session middleware,
   * in here we can add any key we want. for example 'isLoggedIn' 
   * but you can name this however you want
   * and set this 'true'
   */
      req.session.isLoggedIn = true;
      req.session.user = user;
      res.redirect('/');
    })
    .catch(err => console.log(err));
};

```

\* Chapter 237: Using MongoDB To Store Sessions
===============================================

1\. update

- app.js

- The problem is this session is stored in memory and memory is not an infinite resource. so for development, this is fine but for a production server, this would be horrible because if you have thousands of users, your memory will quickly overflow if you store all that information in memory. 

- so we wanna store sessions differently. 

![](images/237-using-mongodb-to-store-sessions-1.png)

- in express github directory, you will find a list of session stores you can use and all kinds of database are supported. you could store it in files though that might not give you the best performance. 

![](images/237-using-mongodb-to-store-sessions-2.png)

![](images/237-using-mongodb-to-store-sessions-3.png)

- and we will use MongoDB because we are already using that and for that, we will use the connect MongoDB session package here.

![](images/237-using-mongodb-to-store-sessions-4.png)

- we will install this package now and register this as a store with which we can work. 

![](images/237-using-mongodb-to-store-sessions-5.png)

- if i click login, and i got a new session, a new session cookie and that session will now be stored in MongoDB

![](images/237-using-mongodb-to-store-sessions-6.png)

![](images/237-using-mongodb-to-store-sessions-7.png)

- in the sessions collection, you will find a session with an ID and in that session, you will find that information like ‘isLoggedIn’ and some information about the cookie which belongs to that session. and also you find the expiry data that was set by default. 

- so this is how sessions are now stored and this is how you should store them for production. use a real session store, don’t use the memory store which is less secure and which also is less unlimited or which will reach limits when more users use your app. 

- with that sessions are a powerful tool for storing data across requests while still scopin them to a single user and not sharing the data across users. because different users have different sessions. this is great way mostly for managing authentication but you could also store something like the shopping cart in a session. 

- in general, use a session for any data that belongs to a user that you don’t wanna lose after every response you send.

```js
//app.js

const path = require('path');

const express = require('express');
const bodyParser = require('body-parser');
const mongoose = require('mongoose')
const session = require('express-session')
/**this will gives you a function which should execute to which you pass your session
 * this 'session' object you are importing from express-session is passed to a function
 * which is yielded by required mongodb-session
 * and the result of that function call is stored in 'MongoDBStore'
 */
const MongoDBStore = require('connect-mongodb-session')(session)

const errorController = require('./controllers/error');
const User = require('./models/user')

const MONGODB_URI = 'mongodb+srv://maximilian:DD5EbADjazBuTqk@cluster0-z3vlk.mongodb.net/shop'

const app = express();
/**'require("connect-mongodb-session")(session)' happens to yield a constructor function which we store in MongoDBStore
 *
 * you pass some options and now which options could that database store require?
 * it will require a connection string
 * because it needs to know in which database server to store your data
 *
 * and i will define the collection
 * and you need to define the collection where your sessions will be stored.
*/
const store = new MongoDBStore({
  uri: MONGODB_URI,
  collection: 'sessions'
})

app.set('view engine', 'ejs');
app.set('views', 'views');

const adminRoutes = require('./routes/admin');
const shopRoutes = require('./routes/shop');
const authRoutes = require('./routes/auth');

/**your session data will be stored in there */
app.use(bodyParser.urlencoded({ extended: false }));
app.use(express.static(path.join(__dirname, 'public')));
app.use(
  session({
    secret: 'my secret',
    resave: false,
    saveUninitialized: false,
    store: store
  })
)

app.use((req, res, next) => {
  User.findById('5cbb2b2c80bd7193adb9eeeb')
    .then(user => {
      req.user = user
      next();
    })
    .catch(err => console.log(err));
});

app.use('/admin', adminRoutes);
app.use(shopRoutes);
app.use(authRoutes)

app.use(errorController.get404);

mongoose
  .connect(
    MONGODB_URI
  )
  .then(result => {
    User
      .findOne()
      .then(user => {
        if(!user){
          const user = new User({
            name: 'Max',
            email: 'max@test.com',
            cart: {
              items: []
            }
          })
          user.save()
        }
      })
    app.listen(3000)
  })
  .catch(err => {
    console.log(err)
  })
```

\* Chapter 238: Sessions & Cookies - A Short Summary
====================================================

![](images/238-sessions-and-cookies-a-short-summary-1.png)

- if you are wondering how the session cookie, this cookie here, how this is set, this is done automatically by express-session. 

![](images/238-sessions-and-cookies-a-short-summary-2.png)

- so by that middleware we are configuring

- and that’s also why you can add cookie related configurations because this middleware automatically sets a cookie for you and it automatically reads the cookie value for you too. so it does all the cookie parsing and setting for you. 

- with that, you rarely need to manage cookies on your own. because that session cookie and with that i don’t mean a cookie which gets lost after you close browser but that cookie that identifies a server side session, that is the most prominent, the most common use case for cookies besides advertisement, tracking which you typically don’t implement on your own but you use 3rd party tools like google for that.

- that session cookie, so that session identifying cookie is an important thing and sessions on the server are often used for authentication but you could use them for any kind of data you wanna store. 

![](images/238-sessions-and-cookies-a-short-summary-3.png)

- we happen to store the information whether the user is logged in. but you could be storing the carts, the shopping cart of the user or anything which belongs to a user which should be shared across requests as i highlighted

\* Chapter 239: Deleting A Cookie
=================================

1\. update

- ./views/includes/navigation.ejs

- ./routes/auth.js

- ./controllers/auth.js

![](images/239-deleting-a-cookie-1.png)

- if we reload our page, we see logout next to login. 

- and when i click this, i wanna clear any session i might have. 

![](images/239-deleting-a-cookie-2.png)

- if i reload, i have got no session cookie here 

![](images/239-deleting-a-cookie-3.png)

- and if i click ‘Login’ button, we can now use that session. 

![](images/239-deleting-a-cookie-4.png)

- if we go to MongoDB Compass, we see we have 4 objects which make sense, 

![](images/239-deleting-a-cookie-5.png)

- and if i click Logout, we are redirected, the session cookie still exists. 

![](images/239-deleting-a-cookie-6.png)

- but you see the session was deleted over there and the session cookie still exists but that is no problem. because no matching session will be found. so that is fine. it’s not doing anything. and it will be renewed once we login again. then this will be overwritten. 

- and when we close the browser, it would also be deleted because it’s not a permanent cookie, it’s a session cookie which means it’s a cookie that doesn’t have an expiry date in the future, it doesn’t have ‘maxAge’, it will get deleted when we close the browser and it’s worthless in this state here.

```js
<!--./views/includes/navigation.ejs-->

<div class="backdrop"></div>
<header class="main-header">
    <button id="side-menu-toggle">Menu</button>
    <nav class="main-header__nav">
        <ul class="main-header__item-list">
            <li class="main-header__item">
                <a class="<%= path === '/' ? 'active' : '' %>" href="/">Shop</a>
            </li>
            <li class="main-header__item">
                <a class="<%= path === '/products' ? 'active' : '' %>" href="/products">Products</a>
            </li>
            <li class="main-header__item">
                <a class="<%= path === '/cart' ? 'active' : '' %>" href="/cart">Cart</a>
            </li>
            <li class="main-header__item">
                <a class="<%= path === '/orders' ? 'active' : '' %>" href="/orders">Orders</a>
            </li>
            <% if (isAuthenticated) { %>
            <li class="main-header__item">
                <a class="<%= path === '/admin/add-product' ? 'active' : '' %>" href="/admin/add-product">Add Product
                </a>
            </li>
            <li class="main-header__item">
                <a class="<%= path === '/admin/products' ? 'active' : '' %>" href="/admin/products">Admin Products
                </a>
            </li>
            <% } %>
        </ul>
        <ul class="main-header__item-list">
            <li class="main-header__item">
                <a class="<%= path === '/login' ? 'active' : '' %>" href="/login">Login</a>
            </li>
            <li class="main-header__item">
                <form action="/logout" method="post">
                    <button type="sutmit">Logout</button>
                </form>
            </li>
        </ul>
    </nav>
</header>

<nav class="mobile-nav">
    <ul class="mobile-nav__item-list">
        <li class="mobile-nav__item">
            <a class="<%= path === '/' ? 'active' : '' %>" href="/">Shop</a>
        </li>
        <li class="mobile-nav__item">
            <a class="<%= path === '/products' ? 'active' : '' %>" href="/products">Products</a>
        </li>
        <li class="mobile-nav__item">
            <a class="<%= path === '/cart' ? 'active' : '' %>" href="/cart">Cart</a>
        </li>
        <li class="mobile-nav__item">
            <a class="<%= path === '/orders' ? 'active' : '' %>" href="/orders">Orders</a>
        </li>
        <li class="mobile-nav__item">
            <a class="<%= path === '/admin/add-product' ? 'active' : '' %>" href="/admin/add-product">Add Product
            </a>
        </li>
        <li class="mobile-nav__item">
            <a class="<%= path === '/admin/products' ? 'active' : '' %>" href="/admin/products">Admin Products
            </a>
        </li>
    </ul>
</nav>
```

```js
// ./routes/auth.js

const express = require('express')

const authController = require('../controllers/auth')

const router = express.Router()

router.get('/login', authController.getLogin)

router.post('/login', authController.postLogin)

router.post('/logout', authController.postLogout)

module.exports = router
```

```js
//./controllers/auth.js

const User = require('../models/user');

exports.getLogin = (req, res, next) => {
  res.render('auth/login', {
    path: '/login',
    pageTitle: 'Login',
    isAuthenticated: false
  });
};

exports.postLogin = (req, res, next) => {
  User.findById('5cbb2b2c80bd7193adb9eeeb')
    .then(user => {
      req.session.isLoggedIn = true;
      req.session.user = user;
      res.redirect('/');
    })
    .catch(err => console.log(err));
};

exports.postLogout = (req, res, next) => {
  /**we can do this by reaching out to our session object
   * and then we can call 'destroy()' there
   * this is a method provided by the session package we are using.
   * 'destroy()' takes a function which we pass to it
   * which will be called once it's done destroying the session 
   * and in there, request session will then not be available anymore
   * because we got rid of that session
   */
  req.session.destroy(err => {
    console.log(err);
    res.redirect('/');
  });
};


```

\* Chapter 240: Fixing Some Minor Bugs
======================================

1\. update

- ./controllers/shop.js

- ./views/includes/navigation.ejs

- ./views/shop/product-list.ejs

- ./vies/includes/add-to-cart.ejs

- ./views/shop/index.ejs

![](images/240-fixing-some-minor-bugs-1.png)

- if i reload this page, we only see shop and products by default

![](images/240-fixing-some-minor-bugs-2.png)

![](images/240-fixing-some-minor-bugs-3.png)

![](images/240-fixing-some-minor-bugs-4.png)

- once i login, we see the rest. 

- and if i click logout, then we see login button

![](images/240-fixing-some-minor-bugs-5.png)

![](images/240-fixing-some-minor-bugs-6.png)

![](images/240-fixing-some-minor-bugs-7.png)

![](images/240-fixing-some-minor-bugs-8.png)

```js
//./controllers/shop.js

const Product = require('../models/product');
const Order = require('../models/order');

exports.getProducts = (req, res, next) => {
  Product.find()
    .then(products => {
      console.log(products);
      res.render('shop/product-list', {
        prods: products,
        pageTitle: 'All Products',
        path: '/products',
        isAuthenticated: req.session.isLoggedIn
      });
    })
    .catch(err => {
      console.log(err);
    });
};

exports.getProduct = (req, res, next) => {
  const prodId = req.params.productId;
  Product.findById(prodId)
    .then(product => {
      res.render('shop/product-detail', {
        product: product,
        pageTitle: product.title,
        path: '/products',
        isAuthenticated: req.session.isLoggedIn
      });
    })
    .catch(err => console.log(err));
};

exports.getIndex = (req, res, next) => {
  Product.find()
    .then(products => {
      res.render('shop/index', {
        prods: products,
        pageTitle: 'Shop',
        path: '/',
        isAuthenticated: req.session.isLoggedIn
      });
    })
    .catch(err => {
      console.log(err);
    });
};

exports.getCart = (req, res, next) => {
  req.user
    .populate('cart.items.productId')
    .execPopulate()
    .then(user => {
      const products = user.cart.items;
      res.render('shop/cart', {
        path: '/cart',
        pageTitle: 'Your Cart',
        products: products,
        isAuthenticated: req.session.isLoggedIn
      });
    })
    .catch(err => console.log(err));
};

exports.postCart = (req, res, next) => {
  const prodId = req.body.productId;
  Product.findById(prodId)
    .then(product => {
      return req.user.addToCart(product);
    })
    .then(result => {
      console.log(result);
      res.redirect('/cart');
    });
};

/**without a valid session and we don't have a valid session now after destroying it
 * all these methods, actions
 * where i do reach out to my user 'req.session.user' to fetch the current orders,
 * these will all fail
 * and this makes sense because we need a session
 * because we need a user for that.
 * so what would work are shop and products and there details
 * 'Add to Cart' will not work though.
 *
 * so first step to improving that besides checking for the existence of a user on the server
 * which we will all add in the authentication module
 * but first thing we can do is that
 * we adjust our frontend to only display things we can interact with based on our current authentication status
 * 
 */
exports.postCartDeleteProduct = (req, res, next) => {
  const prodId = req.body.productId;
  req.user
    .removeFromCart(prodId)
    .then(result => {
      res.redirect('/cart');
    })
    .catch(err => console.log(err));
};

exports.postOrder = (req, res, next) => {
  req.user
    .populate('cart.items.productId')
    .execPopulate()
    .then(user => {
      const products = user.cart.items.map(i => {
        return { quantity: i.quantity, product: { ...i.productId._doc } };
      });
      const order = new Order({
        user: {
          name: req.user.name,
          userId: req.user
        },
        products: products
      });
      return order.save();
    })
    .then(result => {
      return req.user.clearCart();
    })
    .then(() => {
      res.redirect('/orders');
    })
    .catch(err => console.log(err));
};

exports.getOrders = (req, res, next) => {
  Order.find({ 'user.userId': req.user._id })
    .then(orders => {
      res.render('shop/orders', {
        path: '/orders',
        pageTitle: 'Your Orders',
        orders: orders,
        isAuthenticated: req.session.isLoggedIn
      });
    })
    .catch(err => console.log(err));
};

```

```js
<!--./views/includes/navigation.ejs-->

<div class="backdrop"></div>
<header class="main-header">
    <button id="side-menu-toggle">Menu</button>
    <nav class="main-header__nav">
        <ul class="main-header__item-list">
            <li class="main-header__item">
                <a class="<%= path === '/' ? 'active' : '' %>" href="/">Shop</a>
            </li>
            <li class="main-header__item">
                <a class="<%= path === '/products' ? 'active' : '' %>" href="/products">Products</a>
            </li>
            <!--first of all, 'if (isAuthenticated)' should be moved up
                and also include cart and orders
                because these only make sense if we  have a user
                because otherwise as we saw, we will get an error. if we visit these pages
            -->
            <% if (isAuthenticated) { %>
            <li class="main-header__item">
                <a class="<%= path === '/cart' ? 'active' : '' %>" href="/cart">Cart</a>
            </li>
            <li class="main-header__item">
                <a class="<%= path === '/orders' ? 'active' : '' %>" href="/orders">Orders</a>
            </li>
            <li class="main-header__item">
                <a class="<%= path === '/admin/add-product' ? 'active' : '' %>" href="/admin/add-product">Add Product
                </a>
            </li>
            <li class="main-header__item">
                <a class="<%= path === '/admin/products' ? 'active' : '' %>" href="/admin/products">Admin Products
                </a>
            </li>
            <% } %>
        </ul>
        <ul class="main-header__item-list">
            <!--login and logout should only be rendered when we are not logged in.
                so i'm checking if we are authenticated to show 'Add Product' and 'Admin Products',

                and then we can repeat the logic down there
                and only show this entire unordered if we are not authenticated
                so this is not true then i wanna show these items
            -->
            <% if (!isAuthenticated) { %>
            <li class="main-header__item">
                <a class="<%= path === '/login' ? 'active' : '' %>" href="/login">Login</a>
            </li>
            <% } else { %>
            <li class="main-header__item">
                <form action="/logout" method="post">
                    <button type="sutmit">Logout</button>
                </form>
            </li>
            <% } %>
        </ul>
    </nav>
</header>

<nav class="mobile-nav">
    <ul class="mobile-nav__item-list">
        <li class="mobile-nav__item">
            <a class="<%= path === '/' ? 'active' : '' %>" href="/">Shop</a>
        </li>
        <li class="mobile-nav__item">
            <a class="<%= path === '/products' ? 'active' : '' %>" href="/products">Products</a>
        </li>
        <li class="mobile-nav__item">
            <a class="<%= path === '/cart' ? 'active' : '' %>" href="/cart">Cart</a>
        </li>
        <li class="mobile-nav__item">
            <a class="<%= path === '/orders' ? 'active' : '' %>" href="/orders">Orders</a>
        </li>
        <li class="mobile-nav__item">
            <a class="<%= path === '/admin/add-product' ? 'active' : '' %>" href="/admin/add-product">Add Product
            </a>
        </li>
        <li class="mobile-nav__item">
            <a class="<%= path === '/admin/products' ? 'active' : '' %>" href="/admin/products">Admin Products
            </a>
        </li>
    </ul>
</nav>
```

```js
<!--./views/shop/product-list.ejs-->

<%- include('../includes/head.ejs') %>
    <link rel="stylesheet" href="/css/product.css">
    </head>

    <body>
        <%- include('../includes/navigation.ejs') %>

            <main>
                <% if (prods.length > 0) { %>
                    <div class="grid">
                        <% for (let product of prods) { %>
                            <article class="card product-item">
                                <header class="card__header">
                                    <h1 class="product__title">
                                        <%= product.title %>
                                    </h1>
                                </header>
                                <div class="card__image">
                                    <img src="<%= product.imageUrl %>" alt="<%= product.title %>">
                                </div>
                                <div class="card__content">
                                    <h2 class="product__price">$
                                        <%= product.price %>
                                    </h2>
                                    <p class="product__description">
                                        <%= product.description %>
                                    </p>
                                </div>
                                <div class="card__actions">
                                    <a href="/products/<%= product._id %>" class="btn">Details</a>
                                    <% if (!isAuthenticated) { %>
                                        <%- include('../includes/add-to-cart.ejs', {product: product}) %>
                                    <% } %>
                                </div>
                            </article>
                            <% } %>
                    </div>
                    <% } else { %>
                        <h1>No Products Found!</h1>
                        <% } %>
            </main>
            <%- include('../includes/end.ejs') %>
```

```js
<!--./views/includes/add-to-cart.ejs-->


<form action="/cart" method="post">
    <button class="btn" type="submit">Add to Cart</button>
    <input type="hidden" name="productId" value="<%= product._id %>">
</form>

```

```js
<!--./views/shop/index.ejs-->

<%- include('../includes/head.ejs') %>
    <link rel="stylesheet" href="/css/product.css">
</head>

<body>
    <%- include('../includes/navigation.ejs') %>

    <main>
        <% if (prods.length > 0) { %>
            <div class="grid">
                <% for (let product of prods) { %>
                    <article class="card product-item">
                        <header class="card__header">
                            <h1 class="product__title"><%= product.title %></h1>
                        </header>
                        <div class="card__image">
                            <img src="<%= product.imageUrl %>"
                                alt="<%= product.title %>">
                        </div>
                        <div class="card__content">
                            <h2 class="product__price">$<%= product.price %></h2>
                            <p class="product__description"><%= product.description %></p>
                        </div>
                        <div class="card__actions">
                            <a href="/products/<%= product._id %>" class="btn">Details</a>
                            <% if (!isAuthenticated) { %>
                                <%- include('../includes/add-to-cart.ejs', {product: product}) %>
                            <% } %>
                        </div>
                    </article>
                <% } %>
            </div>
        <% } else { %>
            <h1>No Products Found!</h1>
        <% } %>
    </main>
<%- include('../includes/end.ejs') %>
```

\* Chapter 241: Making "Add To Cart" Work Again
===============================================

1\. update

- app.js

- ./controllers/shop.js

- ./controlllers/admin.js

![](images/241-making-add-to-cart-work-again-1.png)

- i clicked ‘Add To Cart’ then we are now failing to do this. 

![](images/241-making-add-to-cart-work-again-2.png)

- and if we go back, we see an error that "‘req.session.user.addToCart’ is not a function” so we somehow fail to execute our ‘Add To Cart’ function

- our functions that normally are available on the user object. why is that? 

- the reason for that is previous setup, we always store the user in the request 'req.user = user’. this was a per request action anyways and we fetched that user for every request in the middleware in app.js file 

- so we fetch the user from the database and mongoose automatically gave us a full user object not just the data in the database. but the full user model with all the methods and we stored that ./models/user.js file, the user model in the request,

- with the session, this works a bit different. with the session, we are not fetching this for every request. instead we store the user in our session upon logging-in in ./controllers/auth.js file like 'req.session.user = user'

- what happens there? it gets stored to the database

![](images/241-making-add-to-cart-work-again-3.png)

- if we go to MongoDB Compass and refresh there, we can see is our user object. and this is just the data. 

![](images/241-making-add-to-cart-work-again-4.png)

- now for every new request, the session middleware doesn’t go ahead and fetch the user with the help of mongoose, it fetches the session data from MongoDB. it uses the MongoDBStore and the MongoDBStore doesn’t know about our mongoose models. 

- so when it fetches the data from session database, when it fetches this data, it only fetches the data. it doesn’t fetch an object with all the methods provided by mongoose. 

![](images/241-making-add-to-cart-work-again-5.png)

- now what can we do regarding that? one thing is that we are reverting back a bit, we can re-add that middle ware which we had earlier after we initialized our session. 

![](images/241-making-add-to-cart-work-again-6.png)

![](images/241-making-add-to-cart-work-again-7.png)

![](images/241-making-add-to-cart-work-again-8.png)

![](images/241-making-add-to-cart-work-again-9.png)

![](images/241-making-add-to-cart-work-again-10.png)

![](images/241-making-add-to-cart-work-again-11.png)

![](images/241-making-add-to-cart-work-again-12.png)

![](images/241-making-add-to-cart-work-again-13.png)

```js
//app.js

const path = require('path');

const express = require('express');
const bodyParser = require('body-parser');
const mongoose = require('mongoose')
const session = require('express-session')
const MongoDBStore = require('connect-mongodb-session')(session)

const errorController = require('./controllers/error');
const User = require('./models/user')

const MONGODB_URI = 'mongodb+srv://maximilian:DD5EbADjazBuTqk@cluster0-z3vlk.mongodb.net/shop'

const app = express();
const store = new MongoDBStore({
  uri: MONGODB_URI,
  collection: 'sessions'
})

app.set('view engine', 'ejs');
app.set('views', 'views');

const adminRoutes = require('./routes/admin');
const shopRoutes = require('./routes/shop');
const authRoutes = require('./routes/auth');

/**your session data will be stored in there */
app.use(bodyParser.urlencoded({ extended: false }));
app.use(express.static(path.join(__dirname, 'public')));
app.use(
  session({
    secret: 'my secret',
    resave: false,
    saveUninitialized: false,
    store: store
  })
)

/**by the time we reach this middleware,
 * we will have our session data loaded
 * this means that now we wanna use that session data to load our real user
 * to create our mongoose user model and how do we do that?
 * 
 * we don't need to reach out to the database again
 * instead we can again set the user for this request only
 * and here i wanna create a user based on data stored in the session
 * so data that persists across requests
 * and i will create that user and store it in the req.user which only live for that request
 * but it's fueled by data from the session 
 * and therefore it also survives cross request
 * 
 * and i need to do that
 * because i need mongoose model to work with
 * because the data we store in the session storage in MongoDB,
 * we retrieve it as just plain data, 
 * not as a mongoose model with all the cool methods mongoose gives us
 * and that is why we get this error regarding 'Add To Cart' not being found and so on.
 * 
 * so here i will initialize req.user 
 * and i don't wanna find a user by Id like this
 * i will find a user by reaching out to 'req.session.user._id'
 * this makes sense because that is the data,
 * the user is what i store in my session
 * and i wanna get the ID and then find that user in the database with the help of the user model which is provided by mongoose
 */
app.use((req, res, next) => {
  if(!req.session.user){
    /**we gonna call 'return next()'
     * so that the code below will not be executed.
     * this code below only run if we don have a session user.
     */
    return next()
  }
  User.findById(req.session.user._id)
  .then(user => {
    /**we don't wanna store anything in the session
     * because the session is already something which will be managed automatically
     * and for the incoming requests, we register the middleware,
     * the middleware will then look for a session cookie,
     * if it finds one, it will look for a fitting session in the database and load the data from there
     */
    //req.session.isLoggedIn = true;
    //req.session.user = user;
    /**here i get back mongoose model user which i store in req.user 
     * and this is what i need now to make sure that i have a mongoose model to work with
     * so that all these cool mongoose methods work again. 
     * 
     * and we need to adjust ./controllers/admin.js and ./controllers/shop.js again
     * and replace 'req.session.user' with 'req.user' again
     * because that is where i'm storing my mongoose model user
    */
    req.user = user
    /** we will call 'next()' so taht the incoming requests can continue with the next middleware. */
    next()
  })
  .catch(err => console.log(err));
})

app.use((req, res, next) => {
  User.findById('5cbb2b2c80bd7193adb9eeeb')
    .then(user => {
      req.user = user
      next();
    })
    .catch(err => console.log(err));
});

app.use('/admin', adminRoutes);
app.use(shopRoutes);
app.use(authRoutes)

app.use(errorController.get404);

mongoose
  .connect(
    MONGODB_URI
  )
  .then(result => {
    User
      .findOne()
      .then(user => {
        if(!user){
          const user = new User({
            name: 'Max',
            email: 'max@test.com',
            cart: {
              items: []
            }
          })
          user.save()
        }
      })
    app.listen(3000)
  })
  .catch(err => {
    console.log(err)
  })
```

```js
//./controllers/shop.js

const Product = require('../models/product');
const Order = require('../models/order');

exports.getProducts = (req, res, next) => {
  Product.find()
    .then(products => {
      console.log(products);
      res.render('shop/product-list', {
        prods: products,
        pageTitle: 'All Products',
        path: '/products',
        isAuthenticated: req.session.isLoggedIn
      });
    })
    .catch(err => {
      console.log(err);
    });
};

exports.getProduct = (req, res, next) => {
  const prodId = req.params.productId;
  Product.findById(prodId)
    .then(product => {
      res.render('shop/product-detail', {
        product: product,
        pageTitle: product.title,
        path: '/products',
        isAuthenticated: req.session.isLoggedIn
      });
    })
    .catch(err => console.log(err));
};

exports.getIndex = (req, res, next) => {
  Product.find()
    .then(products => {
      res.render('shop/index', {
        prods: products,
        pageTitle: 'Shop',
        path: '/',
        isAuthenticated: req.session.isLoggedIn
      });
    })
    .catch(err => {
      console.log(err);
    });
};

/**i wanna replace 'req.session.user' with 'req.user'
 * because we store our mongoose model in that request only object again.
 * do the same in ./controllers/admin.js file
 */
exports.getCart = (req, res, next) => {
  req.user
    .populate('cart.items.productId')
    .execPopulate()
    .then(user => {
      const products = user.cart.items;
      res.render('shop/cart', {
        path: '/cart',
        pageTitle: 'Your Cart',
        products: products,
        isAuthenticated: req.session.isLoggedIn
      });
    })
    .catch(err => console.log(err));
};

exports.postCart = (req, res, next) => {
  const prodId = req.body.productId;
  Product.findById(prodId)
    .then(product => {
      return req.user.addToCart(product);
    })
    .then(result => {
      console.log(result);
      res.redirect('/cart');
    });
};

exports.postCartDeleteProduct = (req, res, next) => {
  const prodId = req.body.productId;
  req.user
    .removeFromCart(prodId)
    .then(result => {
      res.redirect('/cart');
    })
    .catch(err => console.log(err));
};

exports.postOrder = (req, res, next) => {
  req.user
    .populate('cart.items.productId')
    .execPopulate()
    .then(user => {
      const products = user.cart.items.map(i => {
        return { quantity: i.quantity, product: { ...i.productId._doc } };
      });
      const order = new Order({
        user: {
          name: req.user.name,
          userId: req.user
        },
        products: products
      });
      return order.save();
    })
    .then(result => {
      return req.user.clearCart();
    })
    .then(() => {
      res.redirect('/orders');
    })
    .catch(err => console.log(err));
};

exports.getOrders = (req, res, next) => {
  Order.find({ 'user.userId': req.user._id })
    .then(orders => {
      res.render('shop/orders', {
        path: '/orders',
        pageTitle: 'Your Orders',
        orders: orders,
        isAuthenticated: req.session.isLoggedIn
      });
    })
    .catch(err => console.log(err));
};

```

```js
// ./controllers/admin.js

const Product = require('../models/product');

exports.getAddProduct = (req, res, next) => {
  res.render('admin/edit-product', {
    pageTitle: 'Add Product',
    path: '/admin/add-product',
    editing: false,
    isAuthenticated: req.isLoggedIn
  });
};

exports.postAddProduct = (req, res, next) => {
  const title = req.body.title;
  const imageUrl = req.body.imageUrl;
  const price = req.body.price;
  const description = req.body.description;
  const product = new Product({
    title: title,
    price: price,
    description: description,
    imageUrl: imageUrl,
    /**this will not mean that it's now only existent for this request
     * the mongoose model object is but it's fueled by data that is stored in the session
     * and therefore data that persist across requests
     * and now that we saved all of that 
     */
    userId: req.user
  })
  product
    .save()
    .then(result => {
      // console.log(result);
      console.log('Created Product');
      res.redirect('/admin/products');
    })
    .catch(err => {
      console.log(err);
    });
};

exports.getEditProduct = (req, res, next) => {
  const editMode = req.query.edit;
  if (!editMode) {
    return res.redirect('/');
  }
  const prodId = req.params.productId;
  Product.findById(prodId)
    .then(product => {
      if (!product) {
        return res.redirect('/');
      }
      res.render('admin/edit-product', {
        pageTitle: 'Edit Product',
        path: '/admin/edit-product',
        editing: editMode,
        product: product,
        isAuthenticated: req.isLoggedIn
      });
    })
    .catch(err => console.log(err));
};

exports.postEditProduct = (req, res, next) => {
  const prodId = req.body.productId;
  const updatedTitle = req.body.title;
  const updatedPrice = req.body.price;
  const updatedImageUrl = req.body.imageUrl;
  const updatedDesc = req.body.description;

  Product
    .findById(prodId)
    .then(product => {
      product.title = updatedTitle
      product.price = updatedPrice
      product.description = updatedDesc
      product.imageUrl = updatedImageUrl
      return product
      .save()
    })
    .then(result => {
      console.log('UPDATED PRODUCT!');
      res.redirect('/admin/products');
    })
    .catch(err => console.log(err));
};

exports.getProducts = (req, res, next) => {
  Product.find()
//   .select('title price -_id')
//   .popultate('userId', 'name')
    .then(products => {
      console.log(products)
      res.render('admin/products', {
        prods: products,
        pageTitle: 'Admin Products',
        path: '/admin/products',
        isAuthenticated: req.isLoggedIn
      });
    })
    .catch(err => console.log(err));
};

exports.postDeleteProduct = (req, res, next) => {
  const prodId = req.body.productId;
  Product.findByIdAndRemove(prodId)
    .then(() => {
      console.log('DESTROYED PRODUCT');
      res.redirect('/admin/products');
    })
    .catch(err => console.log(err));
};
```

\* Chapter 242: Two Tiny Improvements
=====================================

1\. update

- ./views/shop/product-detail.ejs

- ./controllers/auth.js

![](images/242-two-tiny-improvements-1.png)

![](images/242-two-tiny-improvements-2.png)

![](images/242-two-tiny-improvements-3.png)

![](images/242-two-tiny-improvements-4.png)

![](images/242-two-tiny-improvements-5.png)

![](images/242-two-tiny-improvements-6.png)

![](images/242-two-tiny-improvements-7.png)

———————————

![](images/242-two-tiny-improvements-8.png)

![](images/242-two-tiny-improvements-9.png)

- after logging in, the view didn’t update accordingly. you need to reload the page to get there.

![](images/242-two-tiny-improvements-10.png)

- the reason for this is that in ./controllers/auth.js when i have ‘postLogIn’ here, i set my session and when i redirect, when i send a response the session middleware goes ahead and create that session and that means it writes it to MongoDB because we use the MongoDB sessions Store and it sets the cookie.

- the problem is writing that data to a database like MongoDB can take a couple of milliseconds or depending on your speed even a bit more. the redirect is fired independent from that, so you might redirect too early. 

- to be sure that your session has been set, you can use ‘req.session.save()’

![](images/242-two-tiny-improvements-11.png)

![](images/242-two-tiny-improvements-12.png)

![](images/242-two-tiny-improvements-13.png)

![](images/242-two-tiny-improvements-14.png)

- if i logout, and i again login, now this will only continue once that session has really been created

```js
<!--./views/shop/product-detail.ejs-->

<%- include('../includes/head.ejs') %>
    </head>

    <body>
        <%- include('../includes/navigation.ejs') %>
        <main class="centered">
            <h1><%= product.title %></h1>
            <hr>
            <div class="image">
                <img src="<%= product.imageUrl %>" alt="<%= product.title %>">
            </div>
            <h2><%= product.price %></h2>
            <p><%= product.description %></p>
            <% if (isAuthenticated) { %>
                <%- include('../includes/add-to-cart.ejs') %>
            <% } %>
        </main>
        <%- include('../includes/end.ejs') %>
```

```js
//./controllers/auth.js

const User = require('../models/user');

exports.getLogin = (req, res, next) => {
  res.render('auth/login', {
    path: '/login',
    pageTitle: 'Login',
    isAuthenticated: false
  });
};

exports.postLogin = (req, res, next) => {
  User.findById('5cbb2b2c80bd7193adb9eeeb')
    .then(user => {
      req.session.isLoggedIn = true;
      req.session.user = user;
      /** i set my session and when i redirect,
       * when i send a response the session middleware goes ahead and create that session
       * and that means it writes it to MongoDB
       * because we use the MongoDB sessions Store and it sets the cookie.
       *
       * the problem is writing that data to a database like MongoDB can take a couple of milliseconds or depending on your speed even a bit more.
       * the redirect is fired independent from that,
       * so you might redirect too early.
       *
       * to be sure that your session has been set,
       * you can use ‘req.session.save()'
       * you normally don't need to do that
       * but you need to do it in scenarios
       * where you need to be sure that your session was created before you continue
       * because here you can pass in a function
       * that will be called once you are done saving the session
       *
       * you will get an error here if an error exists
       * and in here you can safely redirect
       * and you can be sure that your session has been created here.
       * 
       * normally you don't need to call 'req.session.save()'
       * if you need that guarantee which typically is the case when you redirect for example
       * because in such scenarios, the redirect will be fired independent from the session being saved
       * and therefore the redirect might be finished
       * and the new page might be rendered before your session was updated on the server and in the database
       * */
      req.session.save((err) => {
        console.log(err)
        res.redirect('/')
      })
    })
    .catch(err => console.log(err));
};

exports.postLogout = (req, res, next) => {
  req.session.destroy(err => {
    console.log(err);
    res.redirect('/');
  });
};


```

\* Chapter 243: Wrap Up
=======================

![](images/243-wrap-up-1.png)