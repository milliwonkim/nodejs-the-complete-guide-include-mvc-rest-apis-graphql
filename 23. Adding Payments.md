\* Chapter 350: How Payments Work
=================================

![](images/350-how-payments-work-1.png)

![](images/350-how-payments-work-2.png)

![350-how-payments-work-1.png](resources/E3522F96C483A80019429C7B2AC60B73.png)![350-how-payments-work-2.png](resources/1E0AD3BFEF465513878808277ACB3B42.png)

\* Chapter 351: Adding A Checkout Page
======================================

1\. update

- ./views/shop/checkout.ejs

- ./routes/shop.js

- ./controllers/shop.js

- ./views/shop/cart.ejs

![](images/351-adding-a-checkout-page-1.png)

![](images/351-adding-a-checkout-page-2.png)

![](images/351-adding-a-checkout-page-3.png)![351-adding-a-checkout-page-1.png](resources/D62C9BB153383789C55ED9CB526F737D.png)![351-adding-a-checkout-page-2.png](resources/52C42ABECA7703184315A7D80795D715.png)![351-adding-a-checkout-page-3.png](resources/9F318A178BEBF8F9E7F704E147761A32.png)

```js
<!--./views/shop/checkout.ejs-->

<%- include('../includes/head.ejs') %>
    <link rel="stylesheet" href="/css/cart.css">

    </head>

    <body>
        <%- include('../includes/navigation.ejs') %>
        <main>
            <ul class="cart__item-list">
                <% products.forEach(p => { %>
                    <li class="cart__item">
                        <h1><%= p.productId.title %></h1>
                        <h2>Quantity: <%= p.quantity %></h2>
                    </li>
                <% }) %>
            </ul>
            <div class="centered">
                <h2>Total: <%= totalSum %></h2>
            </div>
        </main>
        <%- include('../includes/end.ejs') %>
```

```js
// ./routes/shop.js

const path = require('path');

const express = require('express');

const shopController = require('../controllers/shop');
const isAuth = require('../middleware/is-auth');

const router = express.Router();

router.get('/', shopController.getIndex);

router.get('/products', shopController.getProducts);

router.get('/products/:productId', shopController.getProduct);

router.get('/cart', isAuth, shopController.getCart);

router.post('/cart', isAuth, shopController.postCart);

router.post('/cart-delete-item', isAuth, shopController.postCartDeleteProduct);

router.get('/checkout', isAuth, shopController.getCheckout)

router.post('/create-order', isAuth, shopController.postOrder);

router.get('/orders', isAuth, shopController.getOrders);

router.get('/orders/:orderId', isAuth, shopController.getInvoice)

module.exports = router;
```

```js
//./controllers/shop.js

const fs = require('fs');
const path = require('path');

const PDFDocument = require('pdfkit');

const Product = require('../models/product');
const Order = require('../models/order');

const ITEMS_PER_PAGE = 2;

exports.getProducts = (req, res, next) => {
  const page = +req.query.page || 1;
  let totalItems;

  Product.find()
    .countDocuments()
    .then(numProducts => {
      totalItems = numProducts;
      return Product.find()
        .skip((page - 1) * ITEMS_PER_PAGE)
        .limit(ITEMS_PER_PAGE);
    })
    .then(products => {
      res.render('shop/product-list', {
        prods: products,
        pageTitle: 'Products',
        path: '/products',
        currentPage: page,
        hasNextPage: ITEMS_PER_PAGE * page < totalItems,
        hasPreviousPage: page > 1,
        nextPage: page + 1,
        previousPage: page - 1,
        lastPage: Math.ceil(totalItems / ITEMS_PER_PAGE)
      });
    })
    .catch(err => {
      const error = new Error(err);
      error.httpStatusCode = 500;
      return next(error);
    });
};

exports.getProduct = (req, res, next) => {
  const prodId = req.params.productId;
  Product.findById(prodId)
    .then(product => {
      res.render('shop/product-detail', {
        product: product,
        pageTitle: product.title,
        path: '/products'
      });
    })
    .catch(err => {
      const error = new Error(err);
      error.httpStatusCode = 500;
      return next(error);
    });
};

exports.getIndex = (req, res, next) => {
  const page = +req.query.page || 1;
  let totalItems;

  Product.find()
    .countDocuments()
    .then(numProducts => {
      totalItems = numProducts;
      return Product.find()
        .skip((page - 1) * ITEMS_PER_PAGE)
        .limit(ITEMS_PER_PAGE);
    })
    .then(products => {
      res.render('shop/index', {
        prods: products,
        pageTitle: 'Shop',
        path: '/',
        currentPage: page,
        hasNextPage: ITEMS_PER_PAGE * page < totalItems,
        hasPreviousPage: page > 1,
        nextPage: page + 1,
        previousPage: page - 1,
        lastPage: Math.ceil(totalItems / ITEMS_PER_PAGE)
      });
    })
    .catch(err => {
      const error = new Error(err);
      error.httpStatusCode = 500;
      return next(error);
    });
};

exports.getCart = (req, res, next) => {
  req.user
    .populate('cart.items.productId')
    .execPopulate()
    .then(user => {
      const products = user.cart.items;
      res.render('shop/cart', {
        path: '/cart',
        pageTitle: 'Your Cart',
        products: products
      });
    })
    .catch(err => {
      const error = new Error(err);
      error.httpStatusCode = 500;
      return next(error);
    });
};

exports.postCart = (req, res, next) => {
  const prodId = req.body.productId;
  Product.findById(prodId)
    .then(product => {
      return req.user.addToCart(product);
    })
    .then(result => {
      console.log(result);
      res.redirect('/cart');
    })
    .catch(err => {
      const error = new Error(err);
      error.httpStatusCode = 500;
      return next(error);
    });
};

exports.postCartDeleteProduct = (req, res, next) => {
  const prodId = req.body.productId;
  req.user
    .removeFromCart(prodId)
    .then(result => {
      res.redirect('/cart');
    })
    .catch(err => {
      const error = new Error(err);
      error.httpStatusCode = 500;
      return next(error);
    });
};

exports.getCheckout = (req, res, next) => {
  req.user
    .populate('cart.items.productId')
    .execPopulate()
    .then(user => {
      const products = user.cart.items;
      let total = 0
      products.forEach(p => {
        total += p.quantity * p.productId.price
      })
      res.render('shop/checkout', {
        path: '/checkout',
        pageTitle: 'Checkout',
        products: products,
        /**'products' is in an array of products
         * where we have the quantity 
         * and a productId field with detail data about the products
         * because we populate this productId field with the detailed product data
         */
        totalSum: total
      });
    })
    .catch(err => {
      const error = new Error(err);
      error.httpStatusCode = 500;
      return next(error);
    });
}

exports.postOrder = (req, res, next) => {
  req.user
    .populate('cart.items.productId')
    .execPopulate()
    .then(user => {
      const products = user.cart.items.map(i => {
        return { quantity: i.quantity, product: { ...i.productId._doc } };
      });
      const order = new Order({
        user: {
          email: req.user.email,
          userId: req.user
        },
        products: products
      });
      return order.save();
    })
    .then(result => {
      return req.user.clearCart();
    })
    .then(() => {
      res.redirect('/orders');
    })
    .catch(err => {
      const error = new Error(err);
      error.httpStatusCode = 500;
      return next(error);
    });
};

exports.getOrders = (req, res, next) => {
  Order.find({ 'user.userId': req.user._id })
    .then(orders => {
      res.render('shop/orders', {
        path: '/orders',
        pageTitle: 'Your Orders',
        orders: orders
      });
    })
    .catch(err => {
      const error = new Error(err);
      error.httpStatusCode = 500;
      return next(error);
    });
};

exports.getInvoice = (req, res, next) => {
  const orderId = req.params.orderId;
  Order.findById(orderId)
    .then(order => {
      if (!order) {
        return next(new Error('No order found.'));
      }
      if (order.user.userId.toString() !== req.user._id.toString()) {
        return next(new Error('Unauthorized'));
      }
      const invoiceName = 'invoice-' + orderId + '.pdf';
      const invoicePath = path.join('data', 'invoices', invoiceName);

      const pdfDoc = new PDFDocument();
      res.setHeader('Content-Type', 'application/pdf');
      res.setHeader(
        'Content-Disposition',
        'inline; filename="' + invoiceName + '"'
      );
      pdfDoc.pipe(fs.createWriteStream(invoicePath));
      pdfDoc.pipe(res);

      pdfDoc.fontSize(26).text('Invoice', {
        underline: true
      });
      pdfDoc.text('-----------------------');
      let totalPrice = 0;
      order.products.forEach(prod => {
        totalPrice += prod.quantity * prod.product.price;
        pdfDoc
          .fontSize(14)
          .text(
            prod.product.title +
              ' - ' +
              prod.quantity +
              ' x ' +
              '$' +
              prod.product.price
          );
      });
      pdfDoc.text('---');
      pdfDoc.fontSize(20).text('Total Price: $' + totalPrice);

      pdfDoc.end();
      // fs.readFile(invoicePath, (err, data) => {
      //   if (err) {
      //     return next(err);
      //   }
      //   res.setHeader('Content-Type', 'application/pdf');
      //   res.setHeader(
      //     'Content-Disposition',
      //     'inline; filename="' + invoiceName + '"'
      //   );
      //   res.send(data);
      // });
      // const file = fs.createReadStream(invoicePath);

      // file.pipe(res);
    })
    .catch(err => next(err));
};

```

```js
<!--./views/shop/cart.ejs-->

<%- include('../includes/head.ejs') %>
    <link rel="stylesheet" href="/css/cart.css">
    </head>

    <body>
        <%- include('../includes/navigation.ejs') %>
        <main>
            <% if (products.length > 0) { %>
                <ul class="cart__item-list">
                    <% products.forEach(p => { %>
                        <li class="cart__item">
                            <h1><%= p.productId.title %></h1>
                            <h2>Quantity: <%= p.quantity %></h2>
                            <form action="/cart-delete-item" method="POST">
                                <input type="hidden" value="<%= p.productId._id %>" name="productId">
                                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                <button class="btn danger" type="submit">Delete</button>
                            </form>
                        </li>
                    <% }) %>
                </ul>
                <hr>
                <div class="centered">
                    <!--
                    <form action="/create-order" method="POST">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <button type="submit" class="btn">Order Now!</button>
                    </form>
                    -->
                    <a class="btn" href="/checkout">Order Now!</a>
                </div>

            <% } else { %>
                <h1>No Products in Cart!</h1>
            <% } %>
        </main>
        <%- include('../includes/end.ejs') %>
```

\* Chapter 352: Using Stripe In Your App
========================================

1\. update

- ./views/shop/checkout.ejs

- ./controllers/shop.js

- app.js

- ./routes/shop.js

![](images/352-using-stripe-in-your-app-1.png)

![](images/352-using-stripe-in-your-app-2.png)

![](images/352-using-stripe-in-your-app-3.png)![352-using-stripe-in-your-app-1.png](resources/7181EAB9008CC57B0A5B488AC0A1D267.png)![352-using-stripe-in-your-app-2.png](resources/E5CDCDB4BECCDC27632CBC35B92577DC.png)![352-using-stripe-in-your-app-3.png](resources/05A78C3E5FCA4E13DCBD0F1230E8FC7A.png)

———————————————————————

![](images/352-using-stripe-in-your-app-4.png)![352-using-stripe-in-your-app-4.png](resources/75E87A7A2DC3D1C276CFE69FD9297762.png)

- if you wanna build a real application and you wanna push it to the production, you would switch to your live data here. for this, you have to act with your account. we will not do that here.

![](images/352-using-stripe-in-your-app-5.png)

![](images/352-using-stripe-in-your-app-6.png)![352-using-stripe-in-your-app-5.png](resources/C730E3DAC268888C0DFE440B94198644.png)![352-using-stripe-in-your-app-6.png](resources/D7B3F5E6D0B045A878E62E4DA491FA42.png)

- go to ‘Home’ and click ‘Accept your first Payment’. and then official Docs and learn how we can

![](images/352-using-stripe-in-your-app-7.png)![352-using-stripe-in-your-app-7.png](resources/D4D29CD2567FFD16A9725759359189C2.png)

- the coll thing is that this data here is already populated with our data, with our publishable key for example,

![](images/352-using-stripe-in-your-app-8.png)![352-using-stripe-in-your-app-8.png](resources/38F4912BBA518CC25A9939053CF98CCB.png)

- that key you saw under developers API keys, that are keys you need to send with your data to let stripe know to which account this belongs. 

![](images/352-using-stripe-in-your-app-9.png)

![](images/352-using-stripe-in-your-app-10.png)![352-using-stripe-in-your-app-9.png](resources/DCF107DA2F7F50071384B81611D47311.png)![352-using-stripe-in-your-app-10.png](resources/5E78EFB2CAB6ED423E084C23C1A43CE0.png)

- a code snippet we can already use and we can add that to our ./views/shop/checkout.ejs file

![](images/352-using-stripe-in-your-app-11.png)

![](images/352-using-stripe-in-your-app-12.png)![352-using-stripe-in-your-app-11.png](resources/D33C94FB2518C88120A25D2BE8EE341F.png)![352-using-stripe-in-your-app-12.png](resources/9EE266F340D084718C9ABF5612DE71FB.png)

- update version is above. UI is changed.

![](images/352-using-stripe-in-your-app-13.png)

![](images/352-using-stripe-in-your-app-14.png)

![](images/352-using-stripe-in-your-app-15.png)

![](images/352-using-stripe-in-your-app-16.png)

![](images/352-using-stripe-in-your-app-17.png)

![](images/352-using-stripe-in-your-app-18.png)

![](images/352-using-stripe-in-your-app-19.png)

![](images/352-using-stripe-in-your-app-20.png)![352-using-stripe-in-your-app-13.png](resources/65B95025C91AAC74E7DC24C372325BD1.png)![352-using-stripe-in-your-app-14.png](resources/6E834FEFCC6CEEA08BC96845F08F5F44.png)![352-using-stripe-in-your-app-15.png](resources/EFA92488DBA8CD82FB9FE7E370CC59E4.png)![352-using-stripe-in-your-app-16.png](resources/87D24CFE1794290C2BD39E27623945B5.png)![352-using-stripe-in-your-app-17.png](resources/4176E950FA59819C58648A794133146E.png)![352-using-stripe-in-your-app-18.png](resources/11FBA2325AFF08E958EA6B53AF04B53A.png)![352-using-stripe-in-your-app-19.png](resources/3CDCEC5C900BA2603DCBCEC06D707E92.png)![352-using-stripe-in-your-app-20.png](resources/E4BED6AD617FE7C70221636A10571EE0.png)

- now this would send a request to the backend, to the create-order route and there we have to continue because now there we will receive some special data and how to continue is something stripe tells you. 

![](images/352-using-stripe-in-your-app-21.png)

![](images/352-using-stripe-in-your-app-22.png)![352-using-stripe-in-your-app-21.png](resources/99431E88B51202B89E84A64129C09727.png)![352-using-stripe-in-your-app-22.png](resources/B54166B549745DDDD29661606DC7CABC.png)

- you can see how to handle the data on the incoming request and you will see that the incoming request will have a stripe token in its body. 

![](images/352-using-stripe-in-your-app-23.png)

![](images/352-using-stripe-in-your-app-24.png)

![](images/352-using-stripe-in-your-app-25.png)

![](images/352-using-stripe-in-your-app-26.png)

![](images/352-using-stripe-in-your-app-27.png)

![](images/352-using-stripe-in-your-app-28.png)

![352-using-stripe-in-your-app-23.png](resources/0893D7B45248F00361FDD1CA890FD933.png)![352-using-stripe-in-your-app-24.png](resources/61E1B074BC631622BACEF6A24F81E63B.png)![352-using-stripe-in-your-app-25.png](resources/81EA271122EE27617F6AA11281D9EDE9.png)![352-using-stripe-in-your-app-26.png](resources/F28254D77FB348C16BF05A76EA1C0C7C.png)![352-using-stripe-in-your-app-27.png](resources/E9D7C26A1B7A48FE90EE25E9F97045D3.png)![352-using-stripe-in-your-app-28.png](resources/14D4471E9AF3ECC3E29BE0CCAC9AEBD4.png)

```js
<!--./views/shop/checkout.ejs-->

<%- include('../includes/head.ejs') %>
    <link rel="stylesheet" href="/css/cart.css">

    </head>

    <body>
        <%- include('../includes/navigation.ejs') %>
        <main>
            <ul class="cart__item-list">
                <% products.forEach(p => { %>
                    <li class="cart__item">
                        <h1><%= p.productId.title %></h1>
                        <h2>Quantity: <%= p.quantity %></h2>
                    </li>
                <% }) %>
            </ul>
            <div class="centered">
                <h2>Total: <%= totalSum %></h2>
            </div>
            <div class="centered">
                <!--
                    from app.js file,
                    for the request sent by the stripe modal,
                    by that modal we entered our credit card data in,
                    this request doesn't include our CSRF token.
                    so '/checkout' form doesn't include it.

                    you could include your hidden input field
                    but that wouldn't do anything
                    because stripe creates its own form in the end in an ifram which it loads 
                    but that also means that stripe takes care about securing that form
                    so this is not this form
                    which you embed into your document there,
                    stripe renders and loads and secures its own form
                    so you don't need to pass the CSRF token.

                    so this just means we have to disable CSRF token protection for this POST create-order route
                    to do that, i will cut the route from my ./routes/shop.js
                    and i will moe it directly into app.js
                -->
                <form action="/create-order" method="POST">
                    <script
                      src="https://checkout.stripe.com/checkout.js" class="stripe-button"
                      data-key="pk_test_ITc6cUJHHk47xmZcpx3xRmtL00lhes7lVh"
                      data-amount="<%= totalSum %>"
                      data-name="Your Order"
                      data-description="All the items you ordered"
                      data-image="https://stripe.com/img/documentation/checkout/marketplace.png"
                      data-locale="auto"
                      data-currency="usd">
                    </script>
                  </form>            </div>
        </main>
        <%- include('../includes/end.ejs') %>
```

```js
//./controllers/shop.js

const fs = require('fs');
const path = require('path');

const PDFDocument = require('pdfkit');
const stripe = require("stripe")("sk_test_dAPYh6CKcipsTX13kbjOFklT00NICMWhhg");

const Product = require('../models/product');
const Order = require('../models/order');

const ITEMS_PER_PAGE = 2;

exports.getProducts = (req, res, next) => {
  const page = +req.query.page || 1;
  let totalItems;

  Product.find()
    .countDocuments()
    .then(numProducts => {
      totalItems = numProducts;
      return Product.find()
        .skip((page - 1) * ITEMS_PER_PAGE)
        .limit(ITEMS_PER_PAGE);
    })
    .then(products => {
      res.render('shop/product-list', {
        prods: products,
        pageTitle: 'Products',
        path: '/products',
        currentPage: page,
        hasNextPage: ITEMS_PER_PAGE * page < totalItems,
        hasPreviousPage: page > 1,
        nextPage: page + 1,
        previousPage: page - 1,
        lastPage: Math.ceil(totalItems / ITEMS_PER_PAGE)
      });
    })
    .catch(err => {
      const error = new Error(err);
      error.httpStatusCode = 500;
      return next(error);
    });
};

exports.getProduct = (req, res, next) => {
  const prodId = req.params.productId;
  Product.findById(prodId)
    .then(product => {
      res.render('shop/product-detail', {
        product: product,
        pageTitle: product.title,
        path: '/products'
      });
    })
    .catch(err => {
      const error = new Error(err);
      error.httpStatusCode = 500;
      return next(error);
    });
};

exports.getIndex = (req, res, next) => {
  const page = +req.query.page || 1;
  let totalItems;

  Product.find()
    .countDocuments()
    .then(numProducts => {
      totalItems = numProducts;
      return Product.find()
        .skip((page - 1) * ITEMS_PER_PAGE)
        .limit(ITEMS_PER_PAGE);
    })
    .then(products => {
      res.render('shop/index', {
        prods: products,
        pageTitle: 'Shop',
        path: '/',
        currentPage: page,
        hasNextPage: ITEMS_PER_PAGE * page < totalItems,
        hasPreviousPage: page > 1,
        nextPage: page + 1,
        previousPage: page - 1,
        lastPage: Math.ceil(totalItems / ITEMS_PER_PAGE)
      });
    })
    .catch(err => {
      const error = new Error(err);
      error.httpStatusCode = 500;
      return next(error);
    });
};

exports.getCart = (req, res, next) => {
  req.user
    .populate('cart.items.productId')
    .execPopulate()
    .then(user => {
      const products = user.cart.items;
      res.render('shop/cart', {
        path: '/cart',
        pageTitle: 'Your Cart',
        products: products
      });
    })
    .catch(err => {
      const error = new Error(err);
      error.httpStatusCode = 500;
      return next(error);
    });
};

exports.postCart = (req, res, next) => {
  const prodId = req.body.productId;
  Product.findById(prodId)
    .then(product => {
      return req.user.addToCart(product);
    })
    .then(result => {
      console.log(result);
      res.redirect('/cart');
    })
    .catch(err => {
      const error = new Error(err);
      error.httpStatusCode = 500;
      return next(error);
    });
};

exports.postCartDeleteProduct = (req, res, next) => {
  const prodId = req.body.productId;
  req.user
    .removeFromCart(prodId)
    .then(result => {
      res.redirect('/cart');
    })
    .catch(err => {
      const error = new Error(err);
      error.httpStatusCode = 500;
      return next(error);
    });
};

exports.getCheckout = (req, res, next) => {
  req.user
    .populate('cart.items.productId')
    .execPopulate()
    .then(user => {
      const products = user.cart.items;
      let total = 0
      products.forEach(p => {
        total += p.quantity * p.productId.price
      })
      res.render('shop/checkout', {
        path: '/checkout',
        pageTitle: 'Checkout',
        products: products,
        totalSum: total
      });
    })
    .catch(err => {
      const error = new Error(err);
      error.httpStatusCode = 500;
      return next(error);
    });
}

exports.postOrder = (req, res, next) => {
  // Token is created using Checkout or Elements!
  // Get the payment token ID submitted by the form:
  const token = req.body.stripeToken; // Using Express
  let totalSum = 0

  req.user
  .populate('cart.items.productId')
  .execPopulate()
  .then(user => {
    user.cart.items.forEach(p => {
      totalSum += p.quantity * p.productId.price
    })
    const products = user.cart.items.map(i => {
      return { quantity: i.quantity, product: { ...i.productId._doc } };
    });
    const order = new Order({
      user: {
        email: req.user.email,
        userId: req.user
      },
      products: products
    });
    return order.save();
  })
  .then(result => {
    const charge = stripe.charges.create({
      amount: totalSum * 100,
      currency: 'usd',
      description: 'Demo Order',
      /**The source is the token
       * which we extract up
       * so that token which includes the validated credit card data.
       */
      source: token,
      /**some metadata which is a javascript object
       *  where you can pass any arbitrary data you wanna match this order with the charge
       * that will be stored in your stripe account.
       * 
       * 'result_id' should be Id of the created order.
       * 
       * itry to send some extra data in my ./controllers/shop.js
       * to stripe, the resultId should convert to string
       * otherwise this can't be added
       * and therefore my charge failed.
       */
      metadata: {order_id: result._id.toString()}
    })
      return req.user.clearCart();
    })
    .then(() => {
      res.redirect('/orders');
    })
    .catch(err => {
      const error = new Error(err);
      error.httpStatusCode = 500;
      return next(error);
    });
};

exports.getOrders = (req, res, next) => {
  Order.find({ 'user.userId': req.user._id })
    .then(orders => {
      res.render('shop/orders', {
        path: '/orders',
        pageTitle: 'Your Orders',
        orders: orders
      });
    })
    .catch(err => {
      const error = new Error(err);
      error.httpStatusCode = 500;
      return next(error);
    });
};

exports.getInvoice = (req, res, next) => {
  const orderId = req.params.orderId;
  Order.findById(orderId)
    .then(order => {
      if (!order) {
        return next(new Error('No order found.'));
      }
      if (order.user.userId.toString() !== req.user._id.toString()) {
        return next(new Error('Unauthorized'));
      }
      const invoiceName = 'invoice-' + orderId + '.pdf';
      const invoicePath = path.join('data', 'invoices', invoiceName);

      const pdfDoc = new PDFDocument();
      res.setHeader('Content-Type', 'application/pdf');
      res.setHeader(
        'Content-Disposition',
        'inline; filename="' + invoiceName + '"'
      );
      pdfDoc.pipe(fs.createWriteStream(invoicePath));
      pdfDoc.pipe(res);

      pdfDoc.fontSize(26).text('Invoice', {
        underline: true
      });
      pdfDoc.text('-----------------------');
      let totalPrice = 0;
      order.products.forEach(prod => {
        totalPrice += prod.quantity * prod.product.price;
        pdfDoc
          .fontSize(14)
          .text(
            prod.product.title +
              ' - ' +
              prod.quantity +
              ' x ' +
              '$' +
              prod.product.price
          );
      });
      pdfDoc.text('---');
      pdfDoc.fontSize(20).text('Total Price: $' + totalPrice);

      pdfDoc.end();
      // fs.readFile(invoicePath, (err, data) => {
      //   if (err) {
      //     return next(err);
      //   }
      //   res.setHeader('Content-Type', 'application/pdf');
      //   res.setHeader(
      //     'Content-Disposition',
      //     'inline; filename="' + invoiceName + '"'
      //   );
      //   res.send(data);
      // });
      // const file = fs.createReadStream(invoicePath);

      // file.pipe(res);
    })
    .catch(err => next(err));
};

```

```js
//app.js

const path = require('path');

const express = require('express');
const bodyParser = require('body-parser');
const mongoose = require('mongoose');
const session = require('express-session');
const MongoDBStore = require('connect-mongodb-session')(session);
const csrf = require('csurf');
const flash = require('connect-flash');
const multer = require('multer')

const errorController = require('./controllers/error');
const shopController = require('./controllers/shop');
const isAuth = require('./middleware/is-auth');
const User = require('./models/user');

const MONGODB_URI =
'mongodb+srv://maximilian:rldnjs12@cluster0-z3vlk.mongodb.net/shop'

const app = express();
const store = new MongoDBStore({
  uri: MONGODB_URI,
  collection: 'sessions'
});
const csrfProtection = csrf();
const fileStorage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, 'images')
  },
  filename: (req, file, cb) => {
    cb(null, new Date().toISOString() + '-' + file.originalname)
  }
})

const fileFilter = (req, file, cb) => {
  if (
    file.mimetype === 'image/png' || 
    file.mimetype === 'image/jpg' || 
    file.mimetype === 'image/jpeg'
    ) {
    cb(null, true)
  } else {
    cb(null, false)
  }
}

app.set('view engine', 'ejs');
app.set('views', 'views');

const adminRoutes = require('./routes/admin');
const shopRoutes = require('./routes/shop');
const authRoutes = require('./routes/auth');

app.use(bodyParser.urlencoded({ extended: false }));
app.use(multer({ storage: fileStorage, fileFilter }).single('image'))
app.use(express.static(path.join(__dirname, 'public')));
app.use('/images', express.static(path.join(__dirname, 'images')));
app.use(
  session({
    secret: 'my secret',
    resave: false,
    saveUninitialized: false,
    store: store
  })
);
app.use(flash());

app.use((req, res, next) => {
  res.locals.isAuthenticated = req.session.isLoggedIn;
  next();
});

app.use((req, res, next) => {
  //throw new Error('Sync Dummy')
  if (!req.session.user) {
    return next();
  }
  User.findById(req.session.user._id)
    .then(user => {
      if (!user) {
        return next();
      }
      req.user = user;
      next();
    })
    .catch(err => {
      next(new Error(err))
    });
});

/** from app.js file,
  for the request sent by the stripe modal,
  by that modal we entered our credit card data in,
  this request doesn't include our CSRF token.
  so '/checkout' form doesn't include it.

  you could include your hidden input field
  but that wouldn't do anything
  because stripe creates its own form in the end in an ifram which it loads 
  but that also means that stripe takes care about securing that form
  so this is not this form
  which you embed into your document there,
  stripe renders and loads and secures its own form
  so you don't need to pass the CSRF token.

  so this just means we have to disable CSRF token protection for this POST create-order route
  to do that, i will cut the route from my ./routes/shop.js
  and i will moe it directly into app.js

  i will replace 'route.post' with 'app.post'
  because we only have the app available in this file
  then we also have a POST method to only trigger this middleware upon POST request
  
 */

app.post('/create-order', isAuth, shopController.postOrder);

/**the idea is that
 * i initialize this middleware
 * after this route which should not be checked
 * so that only the routes after this will be affected
 * because remember the requests travels through the middleware from top to bottom
 * so CSRF protection only gets added after this routes 
 *    'app.post('/create-order', isAuth, shopController.postOrder);'
 * 
 * so if you have exception of which you typically don't have too many,
 * place it before you enable this middleware
 */
app.use(csrfProtection);
app.use((req, res, next) => {
  res.locals.csrfToken = req.csrfToken();
  next();
});

app.use('/admin', adminRoutes);
app.use(shopRoutes);
app.use(authRoutes);

app.get('/500', errorController.get500);

app.use(errorController.get404);

app.use((error, req, res, next) => {
  /**for the request sent by the stripe modal,
   * by that modal we entered our credit card data in,
   * this request doesn't include our CSRF token.
   * so '/checkout' form doesn't include it.
   */
  //res.redirect('/500')
  res.status(500).render('500', {
    pageTitle: 'Error!',
    path: '/500',
    isAuthenticated: req.session.isLoggedIn
  });
})

mongoose
  .connect(MONGODB_URI)
  .then(result => {
    app.listen(3000);
  })
  .catch(err => {
    console.log(err);
  });

```

```js
// ./routes/shop.js

const path = require('path');

const express = require('express');

const shopController = require('../controllers/shop');
const isAuth = require('../middleware/is-auth');

const router = express.Router();

router.get('/', shopController.getIndex);

router.get('/products', shopController.getProducts);

router.get('/products/:productId', shopController.getProduct);

router.get('/cart', isAuth, shopController.getCart);

router.post('/cart', isAuth, shopController.postCart);

router.post('/cart-delete-item', isAuth, shopController.postCartDeleteProduct);

router.get('/checkout', isAuth, shopController.getCheckout)

router.get('/orders', isAuth, shopController.getOrders);

router.get('/orders/:orderId', isAuth, shopController.getInvoice)

module.exports = router;
```